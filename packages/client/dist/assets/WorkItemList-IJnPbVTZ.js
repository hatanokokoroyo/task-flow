import{d as ee,r as h,w as ie,o as r,c as o,a as e,n as O,t as i,b as x,e as Q,f as y,g as B,h as U,i as te,j as I,s as ue,k as ce,l as me,m as be,u as fe,p as j,q as X,v as ve,F as q,x as K,y as ke}from"./index-Dkm5N9GV.js";import{_ as Y,u as xe,a as ge,S as D,C as pe,b as he}from"./index-BwARp1s_.js";import{d as R,u as se,_ as ye,T as we}from"./Toast-1D9_cmOs.js";import{S as Ce,B as Se,_ as $e}from"./WorkItemForm.vue_vue_type_script_setup_true_lang-DyNPQUcN.js";const _e={class:"flex items-center justify-between gap-3 px-4 py-3"},Ie={class:"min-w-0 flex-1"},Te={key:0,class:"inline-flex items-center gap-1 mb-2 text-xs text-slate-500 dark:text-slate-400"},Me={class:"flex items-center gap-2 mb-1 text-xs text-slate-500 dark:text-slate-400"},Ee={key:0,class:"px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded"},je={key:1,class:"px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded"},Le={key:2,class:"px-2 py-0.5 bg-slate-100 dark:bg-slate-700 rounded"},Ve={class:"font-medium text-slate-800 dark:text-slate-100 truncate"},Ae={key:1,class:"text-slate-500 dark:text-slate-400 text-sm truncate mt-1"},De={class:"px-4 pb-3 flex items-center justify-between text-xs text-slate-400 dark:text-slate-500"},Oe={class:"flex items-center gap-3"},Be={key:0,class:"flex items-center gap-1"},Ne={key:1,class:"flex items-center gap-1"},We={class:"flex items-center justify-between text-xs mb-1"},Re={class:"text-slate-500 dark:text-slate-400"},Ue={class:"text-slate-500 dark:text-slate-400"},ze={class:"h-2 rounded-full bg-slate-100 dark:bg-slate-700 overflow-hidden"},Fe=ee({__name:"WorkItemCard",props:{item:{},depth:{}},emits:["click","edit","delete","status-updated"],setup(n,{emit:z}){var T;const u=n,C=z,w=h(((T=u.item)==null?void 0:T.status)||"pending"),L=h(!1),N=se(),k=I(()=>u.depth??0),V=[{line:"border-l-blue-500 dark:border-l-blue-400",badge:"bg-blue-50 text-blue-700 dark:bg-blue-500/15 dark:text-blue-200",surface:"bg-blue-50/40 dark:bg-slate-800/70"},{line:"border-l-violet-500 dark:border-l-violet-400",badge:"bg-violet-50 text-violet-700 dark:bg-violet-500/15 dark:text-violet-200",surface:"bg-violet-50/40 dark:bg-slate-800/70"},{line:"border-l-emerald-500 dark:border-l-emerald-400",badge:"bg-emerald-50 text-emerald-700 dark:bg-emerald-500/15 dark:text-emerald-200",surface:"bg-emerald-50/40 dark:bg-slate-800/70"},{line:"border-l-amber-500 dark:border-l-amber-400",badge:"bg-amber-50 text-amber-700 dark:bg-amber-500/15 dark:text-amber-200",surface:"bg-amber-50/40 dark:bg-slate-800/70"},{line:"border-l-rose-500 dark:border-l-rose-400",badge:"bg-rose-50 text-rose-700 dark:bg-rose-500/15 dark:text-rose-200",surface:"bg-rose-50/40 dark:bg-slate-800/70"}],S=I(()=>k.value<=0?null:V[(k.value-1)%V.length]),m=I(()=>{var a,t;return k.value>0?`border-l-4 border-slate-200 dark:border-slate-600 ${(a=S.value)==null?void 0:a.line} ${(t=S.value)==null?void 0:t.surface}`:"border-l-4 border-l-slate-300 dark:border-l-slate-600 bg-white dark:bg-slate-800 border-slate-100 dark:border-slate-700"}),$=I(()=>{var a;return((a=S.value)==null?void 0:a.badge)||"bg-slate-100 dark:bg-slate-700"}),g=I(()=>{if(!u.item.startTime||!u.item.endTime)return null;const a=R(u.item.startTime),t=R(u.item.endTime);if(!a.isValid()||!t.isValid()||!t.isAfter(a))return null;const b=R(),c=t.diff(a),F=b.diff(a),A=Math.min(Math.max(F,0),c),P=Math.round(A/c*100),G=t.diff(b)/c,W=Math.min(Math.max(G,0),1);let M="bg-emerald-500";W<=.2?M="bg-rose-500":W<=.5&&(M="bg-amber-500");const f=t.startOf("day").diff(b.startOf("day"),"day"),H=f>=0?`剩余${f}天`:`已逾期${Math.abs(f)}天`;return{percent:P,remainingText:H,barClass:M}});ie(()=>{var a;return(a=u.item)==null?void 0:a.status},a=>{w.value=a||"pending"},{immediate:!0});async function _(a){const t=w.value,b=a.status;L.value=!0;try{await xe(u.item.id,{status:b}),w.value=b,C("status-updated",b),N.success("状态已更新")}catch(c){w.value=t,N.error(c.message||"状态更新失败")}finally{L.value=!1}}function p(a){return a?R(a).format("MM-DD HH:mm"):"--"}return(a,t)=>{var b;return r(),o("div",{class:O(["rounded-lg border hover:shadow-sm transition-shadow cursor-pointer",m.value]),onClick:t[6]||(t[6]=c=>a.$emit("click"))},[e("div",_e,[e("div",Ie,[k.value>0?(r(),o("div",Te,[e("span",{class:O(["px-2 py-0.5 rounded",$.value])},"子项 · 第 "+i(k.value)+" 级",3)])):x("",!0),e("div",Me,[n.item.project?(r(),o("span",Ee,i(n.item.project),1)):x("",!0),n.item.tag?(r(),o("span",je,i(n.item.tag),1)):x("",!0),n.item.type?(r(),o("span",Le,i(n.item.type),1)):x("",!0)]),e("h3",Ve,i(n.item.title),1),n.item.content?(r(),o("p",Ae,i(n.item.content),1)):x("",!0)]),e("div",{class:"flex items-center gap-2 shrink-0",onClick:t[4]||(t[4]=Q(()=>{},["stop"]))},[y(Ce,{modelValue:w.value,"onUpdate:modelValue":t[0]||(t[0]=c=>w.value=c),workItemId:n.item.id,disabled:L.value,onSave:_,onChange:t[1]||(t[1]=c=>_({workItemId:n.item.id,status:c}))},null,8,["modelValue","workItemId","disabled"]),y(Y,{size:"sm",variant:"ghost",onClick:t[2]||(t[2]=c=>a.$emit("edit"))},{default:B(()=>[...t[7]||(t[7]=[U("编辑",-1)])]),_:1}),y(Y,{size:"sm",variant:"ghost",onClick:t[3]||(t[3]=c=>a.$emit("delete"))},{default:B(()=>[...t[8]||(t[8]=[U("删除",-1)])]),_:1})])]),e("div",De,[e("div",Oe,[n.item.childStats?(r(),o("span",Be," 子项 "+i(n.item.childStats.done)+"/"+i(n.item.childStats.total),1)):x("",!0),(b=n.item._count)!=null&&b.comments?(r(),o("span",Ne," 评论 "+i(n.item._count.comments),1)):x("",!0)]),e("span",null,i(p(n.item.updatedAt||n.item.createdAt)),1)]),g.value?(r(),o("div",{key:0,class:"px-4 pb-4",onClick:t[5]||(t[5]=Q(()=>{},["stop"]))},[e("div",We,[e("span",Re,"进度 "+i(g.value.percent)+"%",1),e("span",Ue,i(g.value.remainingText),1)]),e("div",ze,[e("div",{class:O(["h-full rounded-full transition-all",g.value.barClass]),style:te({width:`${g.value.percent}%`})},null,6)])])):x("",!0)],2)}}}),Pe={class:"max-w-7xl mx-auto"},Ge={class:"grid grid-cols-4 gap-4 mb-6"},He={class:"bg-white dark:bg-slate-800 rounded-xl p-5 shadow-sm border border-slate-100 dark:border-slate-700"},Je={class:"text-2xl font-bold text-slate-800 dark:text-white"},qe={class:"bg-white dark:bg-slate-800 rounded-xl p-5 shadow-sm border border-slate-100 dark:border-slate-700"},Ke={class:"text-2xl font-bold text-slate-500 dark:text-slate-400"},Ye={class:"bg-white dark:bg-slate-800 rounded-xl p-5 shadow-sm border border-slate-100 dark:border-slate-700"},Qe={class:"text-2xl font-bold text-blue-500"},Xe={class:"bg-white dark:bg-slate-800 rounded-xl p-5 shadow-sm border border-slate-100 dark:border-slate-700"},Ze={class:"text-2xl font-bold text-green-500"},et={class:"flex items-center justify-between mb-6"},tt={class:"flex items-center gap-4"},st={class:"truncate"},at={key:0,class:"absolute z-50 mt-1 w-52 bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 rounded-lg shadow-lg py-1"},lt=["value"],rt={key:0,class:"text-center py-12 text-slate-400 dark:text-slate-500"},ot={key:1,class:"text-center py-12 text-slate-400 dark:text-slate-500"},nt={key:2,class:"space-y-3"},dt={key:0,class:"flex shrink-0 items-stretch pl-1 pr-2"},Z="taskflow-filter-statuses",bt=ee({__name:"WorkItemList",setup(n){const z=fe(),u=ge(),C=se(),{confirm:w}=he(),{items:L,loading:N,stats:k}=ue(u),V=["border-blue-300 dark:border-blue-500/70","border-violet-300 dark:border-violet-500/70","border-emerald-300 dark:border-emerald-500/70","border-amber-300 dark:border-amber-500/70","border-rose-300 dark:border-rose-500/70"],S=h(""),m=h(F()),$=h(!1),g=h(null),_=h(!1),p=h(null),T=h(!1);let a=null;const t=I(()=>{const l=[],s=(d,v)=>{for(const E of d)l.push({item:E,depth:v}),E.children&&E.children.length>0&&s(E.children,v+1)};return s(L.value,0),l}),b=I(()=>m.value.length===0||m.value.length===Object.keys(D).length?"全部状态":m.value.map(l=>{var s;return(s=D[l])==null?void 0:s.label}).join("、"));function c(l){return V[(l-1)%V.length]}function F(){try{const l=localStorage.getItem(Z);if(l){const s=JSON.parse(l);if(Array.isArray(s))return s}}catch{}return[]}function A(){localStorage.setItem(Z,JSON.stringify(m.value))}function P(){A(),f()}function G(){m.value=Object.keys(D),A(),f()}function W(){m.value=[],A(),f()}function M(l){g.value&&!g.value.contains(l.target)&&($.value=!1)}ce(async()=>{document.addEventListener("click",M),await Promise.all([f(),u.fetchStats()])}),me(()=>{document.removeEventListener("click",M)});async function f(){const l=m.value.length>0&&m.value.length<Object.keys(D).length?m.value.join(","):void 0;await u.fetchWorkItems({status:l,search:S.value||void 0})}function H(){a&&clearTimeout(a),a=window.setTimeout(()=>{f()},300)}function ae(l){z.push(`/work-item/${l}`)}function le(){p.value=null,_.value=!0}function re(l){p.value=l,_.value=!0}function J(){_.value=!1,p.value=null}async function oe(l){T.value=!0;try{p.value?(await u.updateWorkItem(p.value.id,l),C.success("更新成功")):(await u.createWorkItem(l),C.success("创建成功")),J(),await f()}catch(s){C.error(s.message||"操作失败")}finally{T.value=!1}}async function ne(l){if(await w({title:"删除确认",message:`确定要删除工作项"${l.title}"吗？删除后可在回收站恢复。`,type:"danger",confirmText:"删除"}))try{await u.deleteWorkItem(l.id),await f(),C.success("已移至回收站")}catch(d){C.error(d.message||"删除失败")}}async function de(){await Promise.all([f(),u.fetchStats()])}return(l,s)=>(r(),be(ye,{title:"工作项管理"},{default:B(()=>[e("div",Pe,[e("div",Ge,[e("div",He,[e("div",Je,i(j(k).total),1),s[3]||(s[3]=e("div",{class:"text-sm text-slate-500 dark:text-slate-400"},"全部工作项",-1))]),e("div",qe,[e("div",Ke,i(j(k).pending),1),s[4]||(s[4]=e("div",{class:"text-sm text-slate-500 dark:text-slate-400"},"待处理",-1))]),e("div",Ye,[e("div",Qe,i(j(k).inProgress),1),s[5]||(s[5]=e("div",{class:"text-sm text-slate-500 dark:text-slate-400"},"进行中",-1))]),e("div",Xe,[e("div",Ze,i(j(k).done),1),s[6]||(s[6]=e("div",{class:"text-sm text-slate-500 dark:text-slate-400"},"已完成",-1))])]),e("div",et,[e("div",tt,[X(e("input",{"onUpdate:modelValue":s[0]||(s[0]=d=>S.value=d),type:"text",placeholder:"搜索工作项...",class:"px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 focus:border-primary focus:ring-primary focus:outline-none focus:ring-2 focus:ring-opacity-20 w-64 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100",onInput:H},null,544),[[ve,S.value]]),e("div",{class:"relative",ref_key:"dropdownRef",ref:g},[e("button",{type:"button",class:"px-4 py-2 rounded-lg border border-slate-300 dark:border-slate-600 focus:border-primary focus:ring-primary focus:outline-none focus:ring-2 focus:ring-opacity-20 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 min-w-[160px] text-left flex items-center justify-between gap-2",onClick:s[1]||(s[1]=d=>$.value=!$.value)},[e("span",st,i(b.value),1),(r(),o("svg",{class:O(["w-4 h-4 shrink-0 text-slate-400 transition-transform",{"rotate-180":$.value}]),fill:"none",stroke:"currentColor",viewBox:"0 0 24 24"},[...s[7]||(s[7]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M19 9l-7 7-7-7"},null,-1)])],2))]),$.value?(r(),o("div",at,[(r(!0),o(q,null,K(j(D),(d,v)=>(r(),o("label",{key:v,class:"flex items-center gap-2 px-3 py-2 hover:bg-slate-50 dark:hover:bg-slate-600 cursor-pointer text-sm text-slate-700 dark:text-slate-200"},[X(e("input",{type:"checkbox",value:v,"onUpdate:modelValue":s[2]||(s[2]=E=>m.value=E),class:"rounded border-slate-300 dark:border-slate-500 text-primary focus:ring-primary",onChange:P},null,40,lt),[[ke,m.value]]),e("span",{class:"inline-block w-2 h-2 rounded-full",style:te({backgroundColor:d.color})},null,4),U(" "+i(d.label),1)]))),128)),e("div",{class:"border-t border-slate-200 dark:border-slate-600 mt-1 pt-1 px-3 py-1.5 flex justify-between"},[e("button",{type:"button",class:"text-xs text-primary hover:underline",onClick:G},"全选"),e("button",{type:"button",class:"text-xs text-slate-400 hover:text-slate-600 dark:hover:text-slate-300 hover:underline",onClick:W},"清空")])])):x("",!0)],512)]),y(Y,{onClick:le},{default:B(()=>[...s[8]||(s[8]=[U(" ➕ 新建工作项 ",-1)])]),_:1})]),j(N)?(r(),o("div",rt," 加载中... ")):t.value.length===0?(r(),o("div",ot," 暂无工作项 ")):(r(),o("div",nt,[(r(!0),o(q,null,K(t.value,d=>(r(),o("div",{key:d.item.id,class:"flex items-stretch"},[d.depth>0?(r(),o("div",dt,[(r(!0),o(q,null,K(d.depth,v=>(r(),o("div",{key:`${d.item.id}-${v}`,class:"w-4 relative"},[e("div",{class:O(["absolute inset-y-0 left-1/2 -translate-x-1/2 border-l border-dashed",c(v)])},null,2)]))),128))])):x("",!0),y(Fe,{class:"flex-1",item:d.item,depth:d.depth,onClick:v=>ae(d.item.id),onEdit:v=>re(d.item),onDelete:v=>ne(d.item),onStatusUpdated:de},null,8,["item","depth","onClick","onEdit","onDelete"])]))),128))])),y(Se,{visible:_.value,title:p.value?"编辑工作项":"新建工作项",onClose:J},{default:B(()=>[y($e,{"work-item":p.value,loading:T.value,onSubmit:oe,onCancel:J},null,8,["work-item","loading"])]),_:1},8,["visible","title"])]),y(we),y(pe)]),_:1}))}});export{bt as default};
