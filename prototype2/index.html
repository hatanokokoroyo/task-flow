<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥ä½œé¡¹ç®¡ç† - Task Flow</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
            </svg>
          </div>
          <span>Task Flow</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <a href="index.html" class="nav-item active">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
          </span>
          <span>å·¥ä½œé¡¹ç®¡ç†</span>
        </a>
        <a href="daily-log.html" class="nav-item">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </span>
          <span>æ—¥å¿—æŸ¥çœ‹</span>
        </a>
        <a href="recycle-bin.html" class="nav-item">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
            </svg>
          </span>
          <span>å›æ”¶ç«™</span>
        </a>
      </nav>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
      <!-- å¤´éƒ¨ -->
      <header class="header">
        <h1 class="header-title">å·¥ä½œé¡¹ç®¡ç†</h1>
        <div class="header-actions">
          <div class="search-box">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" class="search-input" placeholder="æœç´¢å·¥ä½œé¡¹..." id="searchInput">
          </div>
          <button class="btn btn-primary" onclick="openCreateModal()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="12" y1="5" x2="12" y2="19"></line>
              <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            æ–°å»ºå·¥ä½œé¡¹
          </button>
        </div>
      </header>

      <!-- å†…å®¹åŒº -->
      <div class="content">
        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid" id="statsGrid">
          <!-- åŠ¨æ€æ¸²æŸ“ -->
        </div>

        <!-- ç­›é€‰æ  -->
        <div class="filter-bar">
          <div class="filter-item">
            <label>çŠ¶æ€ç­›é€‰ï¼š</label>
            <select id="statusFilter" onchange="filterWorkItems()">
              <option value="">å…¨éƒ¨çŠ¶æ€</option>
              <option value="pending">å¾…å¤„ç†</option>
              <option value="design">è®¾è®¡ä¸­</option>
              <option value="develop">å¼€å‘ä¸­</option>
              <option value="test">æµ‹è¯•ä¸­</option>
              <option value="delivery">äº¤ä»˜ä¸­</option>
              <option value="done">å·²å®Œæˆ</option>
            </select>
          </div>
          <div class="filter-item">
            <label>æ’åºæ–¹å¼ï¼š</label>
            <select id="sortSelect" onchange="filterWorkItems()">
              <option value="updatedAt">æ›´æ–°æ—¶é—´</option>
              <option value="createdAt">åˆ›å»ºæ—¶é—´</option>
              <option value="startTime">å¼€å§‹æ—¶é—´</option>
              <option value="endTime">ç»“æŸæ—¶é—´</option>
            </select>
          </div>
        </div>

        <!-- å·¥ä½œé¡¹åˆ—è¡¨ -->
        <div class="work-item-list" id="workItemList">
          <!-- åŠ¨æ€æ¸²æŸ“ -->
        </div>
      </div>
    </main>
  </div>

  <!-- åˆ›å»º/ç¼–è¾‘å·¥ä½œé¡¹æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="workItemModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">æ–°å»ºå·¥ä½œé¡¹</h3>
        <button class="modal-close" onclick="closeModal('workItemModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="workItemForm">
          <input type="hidden" id="workItemId">
          <div class="form-group">
            <label class="form-label">æ ‡é¢˜ *</label>
            <input type="text" class="form-input" id="titleInput" required maxlength="200" placeholder="è¯·è¾“å…¥å·¥ä½œé¡¹æ ‡é¢˜">
          </div>
          <div class="form-group">
            <label class="form-label">å†…å®¹</label>
            <textarea class="form-textarea" id="contentInput" maxlength="5000" placeholder="è¯·è¾“å…¥å·¥ä½œé¡¹è¯¦ç»†å†…å®¹"></textarea>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label class="form-label">å¼€å§‹æ—¶é—´</label>
              <input type="datetime-local" class="form-input" id="startTimeInput">
            </div>
            <div class="form-group">
              <label class="form-label">ç»“æŸæ—¶é—´</label>
              <input type="datetime-local" class="form-input" id="endTimeInput">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-select" id="statusInput">
              <option value="pending">å¾…å¤„ç†</option>
              <option value="design">è®¾è®¡ä¸­</option>
              <option value="develop">å¼€å‘ä¸­</option>
              <option value="test">æµ‹è¯•ä¸­</option>
              <option value="delivery">äº¤ä»˜ä¸­</option>
              <option value="done">å·²å®Œæˆ</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('workItemModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveWorkItem()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      renderStats();
      renderWorkItems();
      
      // æœç´¢åŠŸèƒ½
      document.getElementById('searchInput').addEventListener('input', function(e) {
        filterWorkItems();
      });
    });

    // æ¸²æŸ“ç»Ÿè®¡å¡ç‰‡
    function renderStats() {
      const stats = getWorkItemStats();
      const container = document.getElementById('statsGrid');
      container.innerHTML = `
        <div class="stat-card">
          <div class="stat-label">æ€»å·¥ä½œé¡¹</div>
          <div class="stat-value">${stats.total}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å¾…å¤„ç†</div>
          <div class="stat-value" style="color: var(--status-pending)">${stats.pending}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">è¿›è¡Œä¸­</div>
          <div class="stat-value" style="color: var(--primary-color)">${stats.inProgress}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å·²å®Œæˆ</div>
          <div class="stat-value" style="color: var(--status-done)">${stats.done}</div>
        </div>
      `;
    }

    // æ¸²æŸ“å·¥ä½œé¡¹åˆ—è¡¨
    function renderWorkItems(items = null) {
      const container = document.getElementById('workItemList');
      const displayItems = items || workItems;
      
      if (displayItems.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“‹</div>
            <div class="empty-state-title">æš‚æ— å·¥ä½œé¡¹</div>
            <div class="empty-state-desc">ç‚¹å‡»"æ–°å»ºå·¥ä½œé¡¹"æŒ‰é’®åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªå·¥ä½œé¡¹</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = displayItems.map(item => {
        const subStats = calculateSubItemStats(item.subItems || []);
        const progressHtml = subStats ? `
          <div class="work-item-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${subStats.percentage}%"></div>
            </div>
            <div class="progress-text">å­å·¥ä½œé¡¹: ${subStats.done}/${subStats.total} å·²å®Œæˆ (${subStats.percentage}%)</div>
          </div>
        ` : '';
        
        return `
          <div class="work-item-card animate-slide-up" onclick="viewWorkItem(${item.id})">
            <div class="work-item-header">
              <div class="work-item-title">${escapeHtml(item.title)}</div>
              ${getStatusTag(item.status)}
            </div>
            <div class="work-item-meta">
              <span class="work-item-meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12,6 12,12 16,14"></polyline>
                </svg>
                ${item.startTime} - ${item.endTime}
              </span>
              <span class="work-item-meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M21,15a2,2,0,0,1-2,2H7l-4,4V5A2,2,0,0,1,5,3H19a2,2,0,0,1,2,2Z"></path>
                </svg>
                ${(item.comments || []).length} æ¡è¯„è®º
              </span>
              <span class="work-item-meta-item">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                </svg>
                æ›´æ–°äº ${relativeTime(item.updatedAt)}
              </span>
            </div>
            ${progressHtml}
            <div class="table-actions" style="margin-top: 12px;" onclick="event.stopPropagation()">
              <button class="btn btn-sm btn-secondary" onclick="editWorkItem(${item.id})">ç¼–è¾‘</button>
              <button class="btn btn-sm btn-danger" onclick="deleteWorkItem(${item.id})">åˆ é™¤</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ç­›é€‰å·¥ä½œé¡¹
    function filterWorkItems() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const sortBy = document.getElementById('sortSelect').value;
      
      let filtered = [...workItems];
      
      // æœç´¢è¿‡æ»¤
      if (searchText) {
        filtered = filtered.filter(item => 
          item.title.toLowerCase().includes(searchText) ||
          item.content.toLowerCase().includes(searchText)
        );
      }
      
      // çŠ¶æ€è¿‡æ»¤
      if (statusFilter) {
        filtered = filtered.filter(item => item.status === statusFilter);
      }
      
      // æ’åº
      filtered.sort((a, b) => {
        const aVal = new Date(a[sortBy] || a.createdAt);
        const bVal = new Date(b[sortBy] || b.createdAt);
        return bVal - aVal;
      });
      
      renderWorkItems(filtered);
    }

    // æ‰“å¼€åˆ›å»ºæ¨¡æ€æ¡†
    function openCreateModal() {
      document.getElementById('modalTitle').textContent = 'æ–°å»ºå·¥ä½œé¡¹';
      document.getElementById('workItemForm').reset();
      document.getElementById('workItemId').value = '';
      
      // è®¾ç½®é»˜è®¤æ—¶é—´
      const now = new Date();
      const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      document.getElementById('startTimeInput').value = now.toISOString().slice(0, 16);
      document.getElementById('endTimeInput').value = nextWeek.toISOString().slice(0, 16);
      
      openModal('workItemModal');
    }

    // ç¼–è¾‘å·¥ä½œé¡¹
    function editWorkItem(id) {
      const item = findWorkItemById(id);
      if (!item) return;
      
      document.getElementById('modalTitle').textContent = 'ç¼–è¾‘å·¥ä½œé¡¹';
      document.getElementById('workItemId').value = item.id;
      document.getElementById('titleInput').value = item.title;
      document.getElementById('contentInput').value = item.content;
      document.getElementById('statusInput').value = item.status;
      
      // æ—¶é—´æ ¼å¼è½¬æ¢
      if (item.startTime) {
        document.getElementById('startTimeInput').value = item.startTime.replace(' ', 'T');
      }
      if (item.endTime) {
        document.getElementById('endTimeInput').value = item.endTime.replace(' ', 'T');
      }
      
      openModal('workItemModal');
    }

    // ä¿å­˜å·¥ä½œé¡¹
    function saveWorkItem() {
      const id = document.getElementById('workItemId').value;
      const title = document.getElementById('titleInput').value.trim();
      const content = document.getElementById('contentInput').value.trim();
      const status = document.getElementById('statusInput').value;
      const startTime = document.getElementById('startTimeInput').value.replace('T', ' ');
      const endTime = document.getElementById('endTimeInput').value.replace('T', ' ');
      
      if (!title) {
        showToast('è¯·è¾“å…¥æ ‡é¢˜', 'error');
        return;
      }
      
      const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
      
      if (id) {
        // ç¼–è¾‘
        const item = findWorkItemById(id);
        if (item) {
          const oldStatus = item.status;
          item.title = title;
          item.content = content;
          item.status = status;
          item.startTime = startTime;
          item.endTime = endTime;
          item.updatedAt = now;
          
          if (oldStatus !== status) {
            addActivityLog('status', item.id, item.title, 
              `çŠ¶æ€ä»"${STATUS_MAP[oldStatus].label}"å˜æ›´ä¸º"${STATUS_MAP[status].label}"`,
              oldStatus, status);
          } else {
            addActivityLog('update', item.id, item.title, 'æ›´æ–°äº†å·¥ä½œé¡¹å†…å®¹');
          }
          
          showToast('å·¥ä½œé¡¹å·²æ›´æ–°');
        }
      } else {
        // æ–°å»º
        const newItem = {
          id: generateId(),
          title,
          content,
          status,
          startTime,
          endTime,
          createdAt: now,
          updatedAt: now,
          subItems: [],
          comments: []
        };
        workItems.unshift(newItem);
        addActivityLog('create', newItem.id, newItem.title, 'åˆ›å»ºäº†æ–°å·¥ä½œé¡¹');
        showToast('å·¥ä½œé¡¹å·²åˆ›å»º');
      }
      
      saveToLocalStorage();
      closeModal('workItemModal');
      renderStats();
      filterWorkItems();
    }

    // åˆ é™¤å·¥ä½œé¡¹
    async function deleteWorkItem(id) {
      const item = findWorkItemById(id);
      if (!item) return;
      
      const confirmed = await confirmDialog(`ç¡®å®šè¦åˆ é™¤å·¥ä½œé¡¹"${item.title}"å—ï¼Ÿåˆ é™¤åå°†ç§»è‡³å›æ”¶ç«™ã€‚`);
      if (!confirmed) return;
      
      // ç§»è‡³å›æ”¶ç«™
      const now = new Date();
      const expiresAt = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      recycledItems.unshift({
        ...item,
        deletedAt: now.toISOString().replace('T', ' ').substring(0, 19),
        expiresAt: expiresAt.toISOString().replace('T', ' ').substring(0, 19)
      });
      
      // ä»åˆ—è¡¨ç§»é™¤
      workItems = workItems.filter(i => i.id !== id);
      
      addActivityLog('delete', item.id, item.title, 'å·¥ä½œé¡¹è¢«åˆ é™¤åˆ°å›æ”¶ç«™');
      saveToLocalStorage();
      
      showToast('å·¥ä½œé¡¹å·²ç§»è‡³å›æ”¶ç«™');
      renderStats();
      filterWorkItems();
    }

    // æŸ¥çœ‹å·¥ä½œé¡¹è¯¦æƒ…
    function viewWorkItem(id) {
      window.location.href = `work-item-detail.html?id=${id}`;
    }

    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
