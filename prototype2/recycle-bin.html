<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å›æ”¶ç«™ - Task Flow</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
            </svg>
          </div>
          <span>Task Flow</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <a href="index.html" class="nav-item">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
          </span>
          <span>å·¥ä½œé¡¹ç®¡ç†</span>
        </a>
        <a href="daily-log.html" class="nav-item">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </span>
          <span>æ—¥å¿—æŸ¥çœ‹</span>
        </a>
        <a href="recycle-bin.html" class="nav-item active">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
            </svg>
          </span>
          <span>å›æ”¶ç«™</span>
        </a>
      </nav>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
      <!-- å¤´éƒ¨ -->
      <header class="header">
        <h1 class="header-title">å›æ”¶ç«™</h1>
        <div class="header-actions">
          <button class="btn btn-danger" onclick="emptyRecycleBin()" id="emptyBtn">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
              <line x1="10" y1="11" x2="10" y2="17"></line>
              <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            æ¸…ç©ºå›æ”¶ç«™
          </button>
        </div>
      </header>

      <!-- å†…å®¹åŒº -->
      <div class="content">
        <!-- æç¤ºä¿¡æ¯ -->
        <div class="card" style="background: rgba(245, 158, 11, 0.1); border-color: var(--warning-color); margin-bottom: 24px;">
          <div class="card-body" style="display: flex; align-items: center; gap: 12px; padding: 16px 20px;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="var(--warning-color)" stroke-width="2">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="12" y1="8" x2="12" y2="12"></line>
              <line x1="12" y1="16" x2="12.01" y2="16"></line>
            </svg>
            <span style="color: var(--text-primary);">
              å›æ”¶ç«™ä¸­çš„å·¥ä½œé¡¹å°†åœ¨åˆ é™¤å <strong>7å¤©</strong> è‡ªåŠ¨å½»åº•åˆ é™¤ï¼Œè¯·åŠæ—¶æ¢å¤éœ€è¦çš„é¡¹ç›®ã€‚
            </span>
          </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr); max-width: 400px;">
          <div class="stat-card">
            <div class="stat-label">å›æ”¶ç«™é¡¹ç›®</div>
            <div class="stat-value" id="recycleCount">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">å³å°†è¿‡æœŸ</div>
            <div class="stat-value" style="color: var(--danger-color);" id="expiringCount">0</div>
          </div>
        </div>

        <!-- å›æ”¶ç«™åˆ—è¡¨ -->
        <div class="card" style="margin-top: 24px;">
          <div class="card-header">
            <h3 class="card-title">å·²åˆ é™¤çš„å·¥ä½œé¡¹</h3>
          </div>
          <div class="card-body" id="recycleList">
            <!-- åŠ¨æ€æ¸²æŸ“ -->
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="app.js"></script>
  <script>
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // æ£€æŸ¥è¿‡æœŸé¡¹ç›®
      checkExpiredItems();
      renderRecycleList();
    });

    // æ£€æŸ¥å¹¶æ¸…ç†è¿‡æœŸé¡¹ç›®
    function checkExpiredItems() {
      const now = new Date();
      recycledItems = recycledItems.filter(item => {
        const expiresAt = new Date(item.expiresAt);
        return expiresAt > now;
      });
      saveToLocalStorage();
    }

    // æ¸²æŸ“å›æ”¶ç«™åˆ—è¡¨
    function renderRecycleList() {
      const container = document.getElementById('recycleList');
      
      // æ›´æ–°ç»Ÿè®¡
      document.getElementById('recycleCount').textContent = recycledItems.length;
      
      // è®¡ç®—å³å°†è¿‡æœŸï¼ˆ3å¤©å†…ï¼‰
      const now = new Date();
      const threeDaysLater = new Date(now.getTime() + 3 * 24 * 60 * 60 * 1000);
      const expiringCount = recycledItems.filter(item => {
        const expiresAt = new Date(item.expiresAt);
        return expiresAt <= threeDaysLater;
      }).length;
      document.getElementById('expiringCount').textContent = expiringCount;
      
      // æ›´æ–°æ¸…ç©ºæŒ‰é’®çŠ¶æ€
      document.getElementById('emptyBtn').disabled = recycledItems.length === 0;
      
      if (recycledItems.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ—‘ï¸</div>
            <div class="empty-state-title">å›æ”¶ç«™æ˜¯ç©ºçš„</div>
            <div class="empty-state-desc">åˆ é™¤çš„å·¥ä½œé¡¹ä¼šå‡ºç°åœ¨è¿™é‡Œ</div>
          </div>
        `;
        return;
      }
      
      container.innerHTML = recycledItems.map(item => {
        const deletedAt = new Date(item.deletedAt);
        const expiresAt = new Date(item.expiresAt);
        const daysLeft = Math.ceil((expiresAt - now) / (24 * 60 * 60 * 1000));
        const isExpiringSoon = daysLeft <= 3;
        
        return `
          <div class="recycle-item animate-slide-up">
            <div class="recycle-item-info">
              <div class="recycle-item-title">
                ${escapeHtml(item.title)}
                ${getStatusTag(item.status)}
              </div>
              <div class="recycle-item-meta">
                <span>åˆ é™¤äº ${formatDateTime(item.deletedAt, 'datetime')}</span>
                <span style="margin-left: 16px; ${isExpiringSoon ? 'color: var(--danger-color); font-weight: 500;' : ''}">
                  ${isExpiringSoon ? 'âš ï¸' : ''} ${daysLeft}å¤©åè‡ªåŠ¨åˆ é™¤
                </span>
              </div>
            </div>
            <div class="recycle-item-actions">
              <button class="btn btn-success btn-sm" onclick="restoreItem(${item.id})">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="1,4 1,10 7,10"></polyline>
                  <path d="M3.51 15a9 9 0 102.13-9.36L1 10"></path>
                </svg>
                æ¢å¤
              </button>
              <button class="btn btn-danger btn-sm" onclick="permanentDelete(${item.id})">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <line x1="18" y1="6" x2="6" y2="18"></line>
                  <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
                å½»åº•åˆ é™¤
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // æ¢å¤å·¥ä½œé¡¹
    async function restoreItem(id) {
      const item = recycledItems.find(i => i.id === id);
      if (!item) return;
      
      const confirmed = await confirmDialog(`ç¡®å®šè¦æ¢å¤å·¥ä½œé¡¹"${item.title}"å—ï¼Ÿ`);
      if (!confirmed) return;
      
      // ä»å›æ”¶ç«™ç§»é™¤
      recycledItems = recycledItems.filter(i => i.id !== id);
      
      // æ¢å¤åˆ°å·¥ä½œé¡¹åˆ—è¡¨
      const restoredItem = { ...item };
      delete restoredItem.deletedAt;
      delete restoredItem.expiresAt;
      restoredItem.updatedAt = new Date().toISOString().replace('T', ' ').substring(0, 19);
      
      workItems.unshift(restoredItem);
      
      addActivityLog('create', item.id, item.title, 'ä»å›æ”¶ç«™æ¢å¤äº†å·¥ä½œé¡¹');
      saveToLocalStorage();
      
      showToast('å·¥ä½œé¡¹å·²æ¢å¤');
      renderRecycleList();
    }

    // å½»åº•åˆ é™¤
    async function permanentDelete(id) {
      const item = recycledItems.find(i => i.id === id);
      if (!item) return;
      
      const confirmed = await confirmDialog(`ç¡®å®šè¦å½»åº•åˆ é™¤å·¥ä½œé¡¹"${item.title}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
      if (!confirmed) return;
      
      recycledItems = recycledItems.filter(i => i.id !== id);
      saveToLocalStorage();
      
      showToast('å·¥ä½œé¡¹å·²å½»åº•åˆ é™¤');
      renderRecycleList();
    }

    // æ¸…ç©ºå›æ”¶ç«™
    async function emptyRecycleBin() {
      if (recycledItems.length === 0) return;
      
      const confirmed = await confirmDialog(`ç¡®å®šè¦æ¸…ç©ºå›æ”¶ç«™å—ï¼Ÿè¿™å°†å½»åº•åˆ é™¤ ${recycledItems.length} ä¸ªå·¥ä½œé¡¹ï¼Œæ­¤æ“ä½œä¸å¯æ¢å¤ï¼`);
      if (!confirmed) return;
      
      recycledItems = [];
      saveToLocalStorage();
      
      showToast('å›æ”¶ç«™å·²æ¸…ç©º');
      renderRecycleList();
    }

    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
