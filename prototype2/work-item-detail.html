<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å·¥ä½œé¡¹è¯¦æƒ… - Task Flow</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="app-container">
    <!-- ä¾§è¾¹æ  -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <div class="sidebar-logo-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M9 11l3 3L22 4"></path>
              <path d="M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"></path>
            </svg>
          </div>
          <span>Task Flow</span>
        </div>
      </div>
      <nav class="sidebar-nav">
        <a href="index.html" class="nav-item active">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
          </span>
          <span>å·¥ä½œé¡¹ç®¡ç†</span>
        </a>
        <a href="daily-log.html" class="nav-item">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
              <line x1="16" y1="2" x2="16" y2="6"></line>
              <line x1="8" y1="2" x2="8" y2="6"></line>
              <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
          </span>
          <span>æ—¥å¿—æŸ¥çœ‹</span>
        </a>
        <a href="recycle-bin.html" class="nav-item">
          <span class="nav-item-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <polyline points="3,6 5,6 21,6"></polyline>
              <path d="M19,6v14a2,2,0,0,1-2,2H7a2,2,0,0,1-2-2V6m3,0V4a2,2,0,0,1,2-2h4a2,2,0,0,1,2,2V6"></path>
            </svg>
          </span>
          <span>å›æ”¶ç«™</span>
        </a>
      </nav>
    </aside>

    <!-- ä¸»å†…å®¹åŒº -->
    <main class="main-content">
      <!-- å¤´éƒ¨ -->
      <header class="header">
        <div class="breadcrumb">
          <span class="breadcrumb-item"><a href="index.html">å·¥ä½œé¡¹ç®¡ç†</a></span>
          <span class="breadcrumb-separator">â€º</span>
          <span class="breadcrumb-item active" id="breadcrumbTitle">å·¥ä½œé¡¹è¯¦æƒ…</span>
        </div>
        <div class="header-actions">
          <button class="btn btn-secondary" onclick="goBack()">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="19" y1="12" x2="5" y2="12"></line>
              <polyline points="12,19 5,12 12,5"></polyline>
            </svg>
            è¿”å›åˆ—è¡¨
          </button>
        </div>
      </header>

      <!-- å†…å®¹åŒº -->
      <div class="content" id="detailContent">
        <!-- åŠ¨æ€æ¸²æŸ“ -->
      </div>
    </main>
  </div>

  <!-- å­å·¥ä½œé¡¹æ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="subItemModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="subItemModalTitle">æ·»åŠ å­å·¥ä½œé¡¹</h3>
        <button class="modal-close" onclick="closeModal('subItemModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="subItemForm">
          <input type="hidden" id="subItemId">
          <input type="hidden" id="subItemParentId">
          <div class="form-group">
            <label class="form-label">æ ‡é¢˜ *</label>
            <input type="text" class="form-input" id="subItemTitle" required maxlength="200" placeholder="è¯·è¾“å…¥å­å·¥ä½œé¡¹æ ‡é¢˜">
          </div>
          <div class="form-group">
            <label class="form-label">å†…å®¹</label>
            <textarea class="form-textarea" id="subItemContent" maxlength="5000" placeholder="è¯·è¾“å…¥å­å·¥ä½œé¡¹è¯¦ç»†å†…å®¹"></textarea>
          </div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <div class="form-group">
              <label class="form-label">å¼€å§‹æ—¶é—´</label>
              <input type="datetime-local" class="form-input" id="subItemStartTime">
            </div>
            <div class="form-group">
              <label class="form-label">ç»“æŸæ—¶é—´</label>
              <input type="datetime-local" class="form-input" id="subItemEndTime">
            </div>
          </div>
          <div class="form-group">
            <label class="form-label">çŠ¶æ€</label>
            <select class="form-select" id="subItemStatus">
              <option value="pending">å¾…å¤„ç†</option>
              <option value="design">è®¾è®¡ä¸­</option>
              <option value="develop">å¼€å‘ä¸­</option>
              <option value="test">æµ‹è¯•ä¸­</option>
              <option value="delivery">äº¤ä»˜ä¸­</option>
              <option value="done">å·²å®Œæˆ</option>
            </select>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('subItemModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveSubItem()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- è¯„è®ºæ¨¡æ€æ¡† -->
  <div class="modal-overlay" id="commentModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title" id="commentModalTitle">æ·»åŠ è¯„è®º</h3>
        <button class="modal-close" onclick="closeModal('commentModal')">&times;</button>
      </div>
      <div class="modal-body">
        <form id="commentForm">
          <input type="hidden" id="commentId">
          <div class="form-group">
            <label class="form-label">è¯„è®ºå†…å®¹ *</label>
            <textarea class="form-textarea" id="commentContent" required maxlength="2000" placeholder="è¯·è¾“å…¥è¯„è®ºå†…å®¹..." style="min-height: 150px;"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeModal('commentModal')">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveComment()">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <script src="app.js"></script>
  <script>
    let currentWorkItem = null;
    
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      const id = getUrlParam('id');
      if (!id) {
        window.location.href = 'index.html';
        return;
      }
      
      currentWorkItem = findWorkItemById(id);
      if (!currentWorkItem) {
        showToast('å·¥ä½œé¡¹ä¸å­˜åœ¨', 'error');
        setTimeout(() => window.location.href = 'index.html', 1500);
        return;
      }
      
      renderDetail();
    });

    // æ¸²æŸ“è¯¦æƒ…é¡µ
    function renderDetail() {
      document.getElementById('breadcrumbTitle').textContent = currentWorkItem.title;
      document.title = `${currentWorkItem.title} - Task Flow`;
      
      const subStats = calculateSubItemStats(currentWorkItem.subItems || []);
      const statsHtml = subStats ? `
        <div class="stat-card">
          <div class="stat-label">å­å·¥ä½œé¡¹</div>
          <div class="stat-value">${subStats.total}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å·²å®Œæˆ</div>
          <div class="stat-value" style="color: var(--status-done)">${subStats.done}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">è¿›è¡Œä¸­</div>
          <div class="stat-value" style="color: var(--primary-color)">${subStats.inProgress}</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å®Œæˆç‡</div>
          <div class="stat-value">${subStats.percentage}%</div>
        </div>
      ` : '';
      
      const container = document.getElementById('detailContent');
      container.innerHTML = `
        <!-- è¯¦æƒ…å¤´éƒ¨ -->
        <div class="detail-header">
          <div>
            <h1 class="detail-title">${escapeHtml(currentWorkItem.title)}</h1>
            <div class="detail-meta">
              ${getStatusTag(currentWorkItem.status)}
              <span>
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: -2px;">
                  <circle cx="12" cy="12" r="10"></circle>
                  <polyline points="12,6 12,12 16,14"></polyline>
                </svg>
                ${currentWorkItem.startTime} - ${currentWorkItem.endTime}
              </span>
              <span>åˆ›å»ºäº ${formatDateTime(currentWorkItem.createdAt, 'datetime')}</span>
            </div>
          </div>
          <div class="header-actions">
            <button class="btn btn-secondary" onclick="editMainItem()">ç¼–è¾‘</button>
          </div>
        </div>

        ${subStats ? `<div class="stats-grid">${statsHtml}</div>` : ''}

        <div class="detail-content">
          <div class="detail-main">
            <!-- å†…å®¹å¡ç‰‡ -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">è¯¦ç»†å†…å®¹</h3>
              </div>
              <div class="card-body">
                <div style="white-space: pre-wrap; line-height: 1.8;">${escapeHtml(currentWorkItem.content) || '<span style="color: var(--text-light)">æš‚æ— è¯¦ç»†å†…å®¹</span>'}</div>
              </div>
            </div>

            <!-- å­å·¥ä½œé¡¹å¡ç‰‡ -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">å­å·¥ä½œé¡¹ (${(currentWorkItem.subItems || []).length})</h3>
                <button class="btn btn-sm btn-primary" onclick="openAddSubItem(${currentWorkItem.id}, 0)">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  æ·»åŠ å­å·¥ä½œé¡¹
                </button>
              </div>
              <div class="card-body">
                ${renderSubItemTree(currentWorkItem.subItems || [], 0)}
              </div>
            </div>

            <!-- è¯„è®ºå¡ç‰‡ -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">è¯„è®º (${(currentWorkItem.comments || []).length})</h3>
                <button class="btn btn-sm btn-primary" onclick="openAddComment()">
                  <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                  </svg>
                  æ·»åŠ è¯„è®º
                </button>
              </div>
              <div class="card-body">
                ${renderComments(currentWorkItem.comments || [])}
              </div>
            </div>
          </div>

          <div class="detail-sidebar">
            <!-- å¿«é€Ÿæ“ä½œ -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">å¿«é€Ÿæ“ä½œ</h3>
              </div>
              <div class="card-body">
                <div style="display: flex; flex-direction: column; gap: 8px;">
                  <button class="btn btn-secondary" style="width: 100%;" onclick="changeStatus()">å˜æ›´çŠ¶æ€</button>
                  <button class="btn btn-secondary" style="width: 100%;" onclick="openAddSubItem(${currentWorkItem.id}, 0)">æ·»åŠ å­å·¥ä½œé¡¹</button>
                  <button class="btn btn-secondary" style="width: 100%;" onclick="openAddComment()">æ·»åŠ è¯„è®º</button>
                </div>
              </div>
            </div>

            <!-- çŠ¶æ€å˜æ›´å†å² -->
            <div class="card">
              <div class="card-header">
                <h3 class="card-title">æœ€è¿‘åŠ¨æ€</h3>
              </div>
              <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                ${renderRecentLogs()}
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // æ¸²æŸ“å­å·¥ä½œé¡¹æ ‘
    function renderSubItemTree(items, level) {
      if (!items || items.length === 0) {
        if (level === 0) {
          return `
            <div class="empty-state" style="padding: 24px;">
              <div style="color: var(--text-light);">æš‚æ— å­å·¥ä½œé¡¹</div>
            </div>
          `;
        }
        return '';
      }
      
      const html = items.map(item => {
        const hasChildren = item.subItems && item.subItems.length > 0;
        return `
          <div class="sub-item">
            <div class="sub-item-header">
              <div class="sub-item-title">
                ${hasChildren ? `
                  <span class="sub-item-toggle" onclick="toggleSubItem(this)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                      <polyline points="6,9 12,15 18,9"></polyline>
                    </svg>
                  </span>
                ` : '<span style="width: 20px;"></span>'}
                <span>${escapeHtml(item.title)}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 12px;">
                ${getStatusTag(item.status)}
                <div class="table-actions">
                  <button class="btn btn-sm btn-secondary" onclick="openAddSubItem(${item.id}, ${level + 1})">æ·»åŠ å­é¡¹</button>
                  <button class="btn btn-sm btn-secondary" onclick="editSubItem(${item.id})">ç¼–è¾‘</button>
                  <button class="btn btn-sm btn-danger" onclick="deleteSubItem(${item.id})">åˆ é™¤</button>
                </div>
              </div>
            </div>
            <div style="margin-left: 28px; margin-top: 8px; color: var(--text-secondary); font-size: 13px;">
              ${item.content ? escapeHtml(item.content.substring(0, 100)) + (item.content.length > 100 ? '...' : '') : ''}
            </div>
            <div style="margin-left: 28px; margin-top: 4px; color: var(--text-light); font-size: 12px;">
              ${item.startTime} - ${item.endTime}
            </div>
            ${hasChildren ? `
              <div class="sub-item-tree" style="margin-top: 12px;">
                ${renderSubItemTree(item.subItems, level + 1)}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      return `<div class="sub-item-tree">${html}</div>`;
    }

    // æ¸²æŸ“è¯„è®ºåˆ—è¡¨
    function renderComments(comments) {
      if (!comments || comments.length === 0) {
        return `
          <div class="empty-state" style="padding: 24px;">
            <div style="color: var(--text-light);">æš‚æ— è¯„è®º</div>
          </div>
        `;
      }
      
      return `
        <div class="comment-list">
          ${comments.map(comment => `
            <div class="comment-item">
              <div class="comment-avatar">æˆ‘</div>
              <div class="comment-body">
                <div class="comment-header">
                  <span class="comment-author">æˆ‘</span>
                  <span class="comment-time">${formatDateTime(comment.createdAt, 'datetime')}</span>
                </div>
                <div class="comment-content">${escapeHtml(comment.content).replace(/\n/g, '<br>')}</div>
                <div class="comment-actions">
                  <span class="comment-action" onclick="editComment(${comment.id})">ç¼–è¾‘</span>
                  <span class="comment-action" onclick="deleteComment(${comment.id})">åˆ é™¤</span>
                </div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // æ¸²æŸ“æœ€è¿‘æ—¥å¿—
    function renderRecentLogs() {
      const logs = activityLogs
        .filter(log => log.workItemId === currentWorkItem.id)
        .slice(0, 5);
      
      if (logs.length === 0) {
        return '<div style="color: var(--text-light); text-align: center;">æš‚æ— åŠ¨æ€</div>';
      }
      
      return `
        <div class="log-list" style="padding: 0;">
          ${logs.map(log => `
            <div class="log-item" style="padding: 8px 0;">
              <div class="log-icon ${log.type}" style="width: 28px; height: 28px; font-size: 12px;">
                ${getLogIcon(log.type)}
              </div>
              <div class="log-content">
                <div class="log-desc" style="font-size: 12px;">${log.description}</div>
                <div class="log-time" style="font-size: 11px;">${relativeTime(log.createdAt)}</div>
              </div>
            </div>
          `).join('')}
        </div>
      `;
    }

    // è·å–æ—¥å¿—å›¾æ ‡
    function getLogIcon(type) {
      const icons = {
        create: '+',
        update: 'âœ',
        status: 'â†»',
        comment: 'ğŸ’¬',
        delete: 'Ã—'
      };
      return icons[type] || 'â€¢';
    }

    // åˆ‡æ¢å­å·¥ä½œé¡¹å±•å¼€/æŠ˜å 
    function toggleSubItem(el) {
      const subTree = el.closest('.sub-item').querySelector('.sub-item-tree');
      if (subTree) {
        const isHidden = subTree.style.display === 'none';
        subTree.style.display = isHidden ? 'block' : 'none';
        el.querySelector('svg').style.transform = isHidden ? '' : 'rotate(-90deg)';
      }
    }

    // æ‰“å¼€æ·»åŠ å­å·¥ä½œé¡¹
    function openAddSubItem(parentId, level) {
      if (level >= 3) {
        showToast('å­å·¥ä½œé¡¹æœ€å¤šæ”¯æŒä¸‰çº§åµŒå¥—', 'error');
        return;
      }
      
      document.getElementById('subItemModalTitle').textContent = 'æ·»åŠ å­å·¥ä½œé¡¹';
      document.getElementById('subItemForm').reset();
      document.getElementById('subItemId').value = '';
      document.getElementById('subItemParentId').value = parentId;
      
      const now = new Date();
      const nextWeek = new Date(now.getTime() + 7 * 24 * 60 * 60 * 1000);
      document.getElementById('subItemStartTime').value = now.toISOString().slice(0, 16);
      document.getElementById('subItemEndTime').value = nextWeek.toISOString().slice(0, 16);
      
      openModal('subItemModal');
    }

    // æŸ¥æ‰¾å­å·¥ä½œé¡¹
    function findSubItem(items, id) {
      for (const item of items) {
        if (item.id === id) return item;
        if (item.subItems && item.subItems.length > 0) {
          const found = findSubItem(item.subItems, id);
          if (found) return found;
        }
      }
      return null;
    }

    // æŸ¥æ‰¾çˆ¶é¡¹
    function findParentOfSubItem(items, id, parent = null) {
      for (const item of items) {
        if (item.id === id) return parent;
        if (item.subItems && item.subItems.length > 0) {
          const found = findParentOfSubItem(item.subItems, id, item);
          if (found !== undefined) return found;
        }
      }
      return undefined;
    }

    // ç¼–è¾‘å­å·¥ä½œé¡¹
    function editSubItem(id) {
      const item = findSubItem(currentWorkItem.subItems, id);
      if (!item) return;
      
      document.getElementById('subItemModalTitle').textContent = 'ç¼–è¾‘å­å·¥ä½œé¡¹';
      document.getElementById('subItemId').value = item.id;
      document.getElementById('subItemParentId').value = item.parentId;
      document.getElementById('subItemTitle').value = item.title;
      document.getElementById('subItemContent').value = item.content || '';
      document.getElementById('subItemStatus').value = item.status;
      
      if (item.startTime) {
        document.getElementById('subItemStartTime').value = item.startTime.replace(' ', 'T');
      }
      if (item.endTime) {
        document.getElementById('subItemEndTime').value = item.endTime.replace(' ', 'T');
      }
      
      openModal('subItemModal');
    }

    // ä¿å­˜å­å·¥ä½œé¡¹
    function saveSubItem() {
      const id = document.getElementById('subItemId').value;
      const parentId = parseInt(document.getElementById('subItemParentId').value);
      const title = document.getElementById('subItemTitle').value.trim();
      const content = document.getElementById('subItemContent').value.trim();
      const status = document.getElementById('subItemStatus').value;
      const startTime = document.getElementById('subItemStartTime').value.replace('T', ' ');
      const endTime = document.getElementById('subItemEndTime').value.replace('T', ' ');
      
      if (!title) {
        showToast('è¯·è¾“å…¥æ ‡é¢˜', 'error');
        return;
      }
      
      const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
      
      if (id) {
        // ç¼–è¾‘
        const item = findSubItem(currentWorkItem.subItems, parseInt(id));
        if (item) {
          const oldStatus = item.status;
          item.title = title;
          item.content = content;
          item.status = status;
          item.startTime = startTime;
          item.endTime = endTime;
          
          if (oldStatus !== status) {
            addActivityLog('status', currentWorkItem.id, currentWorkItem.title,
              `å­å·¥ä½œé¡¹"${title}"çŠ¶æ€ä»"${STATUS_MAP[oldStatus].label}"å˜æ›´ä¸º"${STATUS_MAP[status].label}"`,
              oldStatus, status);
          }
          
          showToast('å­å·¥ä½œé¡¹å·²æ›´æ–°');
        }
      } else {
        // æ–°å»º
        const newSubItem = {
          id: generateId(),
          parentId: parentId,
          title,
          content,
          status,
          startTime,
          endTime,
          createdAt: now,
          subItems: []
        };
        
        if (parentId === currentWorkItem.id) {
          currentWorkItem.subItems.push(newSubItem);
        } else {
          const parent = findSubItem(currentWorkItem.subItems, parentId);
          if (parent) {
            if (!parent.subItems) parent.subItems = [];
            parent.subItems.push(newSubItem);
          }
        }
        
        addActivityLog('create', currentWorkItem.id, currentWorkItem.title, `åˆ›å»ºäº†å­å·¥ä½œé¡¹"${title}"`);
        showToast('å­å·¥ä½œé¡¹å·²åˆ›å»º');
      }
      
      currentWorkItem.updatedAt = now;
      saveToLocalStorage();
      closeModal('subItemModal');
      renderDetail();
    }

    // åˆ é™¤å­å·¥ä½œé¡¹
    async function deleteSubItem(id) {
      const item = findSubItem(currentWorkItem.subItems, id);
      if (!item) return;
      
      const confirmed = await confirmDialog(`ç¡®å®šè¦åˆ é™¤å­å·¥ä½œé¡¹"${item.title}"å—ï¼Ÿå…¶ä¸‹çš„å­å·¥ä½œé¡¹ä¹Ÿå°†è¢«åˆ é™¤ã€‚`);
      if (!confirmed) return;
      
      function removeFromArray(items) {
        const index = items.findIndex(i => i.id === id);
        if (index !== -1) {
          items.splice(index, 1);
          return true;
        }
        for (const item of items) {
          if (item.subItems && removeFromArray(item.subItems)) return true;
        }
        return false;
      }
      
      removeFromArray(currentWorkItem.subItems);
      currentWorkItem.updatedAt = new Date().toISOString().replace('T', ' ').substring(0, 19);
      
      addActivityLog('delete', currentWorkItem.id, currentWorkItem.title, `åˆ é™¤äº†å­å·¥ä½œé¡¹"${item.title}"`);
      saveToLocalStorage();
      
      showToast('å­å·¥ä½œé¡¹å·²åˆ é™¤');
      renderDetail();
    }

    // æ‰“å¼€æ·»åŠ è¯„è®º
    function openAddComment() {
      document.getElementById('commentModalTitle').textContent = 'æ·»åŠ è¯„è®º';
      document.getElementById('commentForm').reset();
      document.getElementById('commentId').value = '';
      openModal('commentModal');
    }

    // ç¼–è¾‘è¯„è®º
    function editComment(id) {
      const comment = currentWorkItem.comments.find(c => c.id === id);
      if (!comment) return;
      
      document.getElementById('commentModalTitle').textContent = 'ç¼–è¾‘è¯„è®º';
      document.getElementById('commentId').value = comment.id;
      document.getElementById('commentContent').value = comment.content;
      openModal('commentModal');
    }

    // ä¿å­˜è¯„è®º
    function saveComment() {
      const id = document.getElementById('commentId').value;
      const content = document.getElementById('commentContent').value.trim();
      
      if (!content) {
        showToast('è¯·è¾“å…¥è¯„è®ºå†…å®¹', 'error');
        return;
      }
      
      const now = new Date().toISOString().replace('T', ' ').substring(0, 19);
      
      if (id) {
        // ç¼–è¾‘
        const comment = currentWorkItem.comments.find(c => c.id === parseInt(id));
        if (comment) {
          comment.content = content;
          comment.updatedAt = now;
          showToast('è¯„è®ºå·²æ›´æ–°');
        }
      } else {
        // æ–°å»º
        const newComment = {
          id: generateId(),
          content,
          createdAt: now,
          updatedAt: null
        };
        currentWorkItem.comments.push(newComment);
        addActivityLog('comment', currentWorkItem.id, currentWorkItem.title, 'æ·»åŠ äº†æ–°è¯„è®º');
        showToast('è¯„è®ºå·²æ·»åŠ ');
      }
      
      currentWorkItem.updatedAt = now;
      saveToLocalStorage();
      closeModal('commentModal');
      renderDetail();
    }

    // åˆ é™¤è¯„è®º
    async function deleteComment(id) {
      const confirmed = await confirmDialog('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¯„è®ºå—ï¼Ÿ');
      if (!confirmed) return;
      
      currentWorkItem.comments = currentWorkItem.comments.filter(c => c.id !== id);
      currentWorkItem.updatedAt = new Date().toISOString().replace('T', ' ').substring(0, 19);
      saveToLocalStorage();
      
      showToast('è¯„è®ºå·²åˆ é™¤');
      renderDetail();
    }

    // å˜æ›´çŠ¶æ€
    async function changeStatus() {
      const currentStatus = currentWorkItem.status;
      
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay active';
      overlay.innerHTML = `
        <div class="modal" style="max-width: 400px;">
          <div class="modal-header">
            <h3 class="modal-title">å˜æ›´çŠ¶æ€</h3>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">&times;</button>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <label class="form-label">é€‰æ‹©æ–°çŠ¶æ€</label>
              <select class="form-select" id="newStatusSelect">
                ${STATUS_OPTIONS.map(s => 
                  `<option value="${s.value}" ${s.value === currentStatus ? 'selected' : ''}>${s.label}</option>`
                ).join('')}
              </select>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">å–æ¶ˆ</button>
            <button class="btn btn-primary" onclick="confirmStatusChange()">ç¡®å®š</button>
          </div>
        </div>
      `;
      document.body.appendChild(overlay);
      
      window.confirmStatusChange = function() {
        const newStatus = document.getElementById('newStatusSelect').value;
        if (newStatus !== currentStatus) {
          const oldStatus = currentWorkItem.status;
          currentWorkItem.status = newStatus;
          currentWorkItem.updatedAt = new Date().toISOString().replace('T', ' ').substring(0, 19);
          
          addActivityLog('status', currentWorkItem.id, currentWorkItem.title,
            `çŠ¶æ€ä»"${STATUS_MAP[oldStatus].label}"å˜æ›´ä¸º"${STATUS_MAP[newStatus].label}"`,
            oldStatus, newStatus);
          
          saveToLocalStorage();
          showToast('çŠ¶æ€å·²æ›´æ–°');
          renderDetail();
        }
        overlay.remove();
      };
    }

    // ç¼–è¾‘ä¸»å·¥ä½œé¡¹
    function editMainItem() {
      window.location.href = `index.html?edit=${currentWorkItem.id}`;
    }

    // è¿”å›åˆ—è¡¨
    function goBack() {
      window.location.href = 'index.html';
    }

    // HTMLè½¬ä¹‰
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
