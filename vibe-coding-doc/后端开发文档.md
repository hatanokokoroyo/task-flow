# Task Flow 后端开发文档

## 1. 数据库数据结构设计
使用 SQLite 3，通过 SQLAlchemy 2.0 进行 ORM 映射。

### 1.1 核心实体表

#### `work_items` (工作项)
| 字段名     | 类型        | 约束          | 说明                                        |
| :--------- | :---------- | :------------ | :------------------------------------------ |
| id         | Integer     | PK            | 主键                                        |
| parent_id  | Integer     | FK            | 父任务ID (实现嵌套，顶级任务为NULL)         |
| title      | String(200) | Not Null      | 任务标题                                    |
| content    | Text        | -             | 任务详细描述 (支持5000字，本地存储)         |
| status     | String      | Not Null      | 状态: TODO, DESIGN, DEV, TEST, DEPLOY, DONE |
| start_time | DateTime    | -             | 记录开始时间                                |
| end_time   | DateTime    | -             | 记录结束时间                                |
| created_at | DateTime    | Default Now   | 创建时间                                    |
| updated_at | DateTime    | Default Now   | 最后修改时间                                |
| is_deleted | Boolean     | Default False | 逻辑删除标记 (回收站)                       |
| deleted_at | DateTime    | -             | 删除时刻 (用于7天后彻底清理判断)            |

#### `comments` (评论)
| 字段名       | 类型     | 约束        | 说明                  |
| :----------- | :------- | :---------- | :-------------------- |
| id           | Integer  | PK          | 主键                  |
| work_item_id | Integer  | FK          | 关联的工作项ID        |
| content      | Text     | Not Null    | 评论内容 (支持2000字) |
| created_at   | DateTime | Default Now | 提交时间              |

#### `activity_logs` (操作日志)
| 字段名       | 类型     | 约束        | 说明                                           |
| :----------- | :------- | :---------- | :--------------------------------------------- |
| id           | Integer  | PK          | 主键                                           |
| work_item_id | Integer  | FK          | 关联的工作项ID                                 |
| action_type  | String   | Not Null    | 类型: CREATE, STATUS_CHANGE, COMMENT_ADD, EDIT |
| old_value    | Text     | -           | 变更前的值 (如状态名)                          |
| new_value    | Text     | -           | 变更后的值                                     |
| summary      | Text     | -           | 日志摘要文本                                   |
| created_at   | DateTime | Default Now | 操作时间                                       |

---

## 2. 后端开发规范说明

### 2.1 技术选型要求
- **框架**: FastAPI (异步处理)。
- **校验**: Pydantic v2 用于模型验证。

### 2.2 接口响应标准
所有 API 接口必须符合以下 JSON 格式：
```json
{
  "code": 200,    // 业务状态码
  "data": null,   // 业务数据对象或数组
  "message": ""   // 错误描述信息
}
```

### 2.3 开发准则
- **状态管理**: 状态变更必须级联更新 `updated_at`。
- **物理删除**: 仅在回收站手动清理或 7 天到期脚本中执行 `DELETE`。
- **事务处理**: 涉及工作项创建及首条日志记录时，必须使用数据库事务。

---

## 3. API 设计文档

### 3.1 工作项接口 (Work Items)
- `GET /api/work-items`: 获取工作项列表。支持参数 `status`, `search`, `sort_by`。
- `POST /api/work-items`: 创建工作项。自动创建 "CREATE" 类型日志。
- `GET /api/work-items/{id}`: 获取详情。需包含子任务列表及最新评论。
- `PATCH /api/work-items/{id}/status`: 变更状态。需记录状态变更日志。
- `DELETE /api/work-items/{id}`: 软删除。移动至回收站。

### 3.2 评论接口 (Comments)
- `POST /api/work-items/{id}/comments`: 发表评论。
- `DELETE /api/comments/{id}`: 删除评论。

### 3.3 日志接口 (Daily Logs)
- `GET /api/logs/daily`: 获取日历视图统计（每天的操作数量）。
- `GET /api/logs?date=YYYY-MM-DD`: 获取指定日期的详细操作流。
- `GET /api/logs/export`: 导出指定范围日志为 Markdown。

### 3.4 回收站 (Recycle Bin)
- `GET /api/recycle-bin`: 获取已删除的工作项。
- `POST /api/recycle-bin/{id}/restore`: 恢复任务。
- `DELETE /api/recycle-bin/{id}`: 彻底删除。

---

## 4. 项目目录设计和说明

```text
backend/
├── app/
│   ├── main.py             # FastAPI 实例创建与全局配置
│   ├── api/                # API 路由层
│   │   ├── api_v1/         # 版本化路由
│   │   │   ├── endpoints/  # 具体业务端点 (work_items.py, logs.py)
│   │   └── router.py       # 总路由分发
│   ├── core/               # 核心层
│   │   ├── config.py       # 环境变量与应用配置
│   │   └── security.py     # 权限相关 (后续扩展)
│   ├── db/                 # 数据库层
│   │   ├── base.py         # 导入所有模型供 Alembic 使用
│   │   └── session.py      # 引擎创建与 Session 获取
│   ├── models/             # SQLAlchemy ORM 模型定义
│   ├── schemas/            # Pydantic 数据模型 (Request/Response DTO)
│   ├── services/           # 业务逻辑层 (处理复杂逻辑与日志自动生成)
│   └── crud/               # 基础数据库增删改查
├── data/                   # 存放 task_flow.db 数据库文件
├── tests/                  # 单元测试与集成测试
├── alembic/                # 数据库迁移脚本 (可选)
├── .env                    # 环境配置文件
└── requirements.txt        # 依赖列表
```
