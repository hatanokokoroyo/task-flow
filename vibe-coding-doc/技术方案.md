# Task Flow 技术方案

## 1. 项目概述

Task Flow 是一款轻量级的个人工作日志管理系统，聚焦以下场景：
- 🧭 工作项规划：支持顶层工作项与多级子项的树形管理，便于拆解复杂任务。
- ✍️ 协同记录：提供 Markdown 描述、评论流与操作日志，完整还原工作上下文。
- 📊 过程跟踪：状态标签、进度条、统计卡片、日历视图帮助掌握执行节奏。
- 🗑️ 生命周期：软删除 + 回收站 + 7 天自动清理，兼顾安全与可恢复性。

系统采用前后端分离架构，所有数据存储在本地 SQLite 数据库中，适合个人与小团队快速部署、自主掌控数据。

## 2. 技术栈

### 2.1 前端

| 技术 | 版本 | 说明 |
|------|------|------|
| Vue | 3.x | 组合式 API + 单文件组件 |
| TypeScript | 5.x | 静态类型约束 |
| Vite | 5.x | 极速构建与热更新 |
| Pinia | 2.x | 轻量状态管理 |
| Vue Router | 4.x | 前端路由 |
| TailwindCSS | 3.x | 原子化样式体系 |
| Axios | 1.x | HTTP 客户端，集中处理响应码 |
| Day.js | 1.x | 日期处理与格式化 |
| Marked | 17.x | Markdown 渲染器 |

### 2.2 后端

| 技术 | 版本 | 说明 |
|------|------|------|
| Node.js | 20.x LTS | 运行时环境 |
| Express | 4.x | Web 框架 |
| TypeScript | 5.x | 类型约束 |
| Prisma | 5.x | ORM，自动生成数据模型 |
| SQLite | 3.x | 内嵌式数据库 |
| Zod | 3.x | 请求体验证 |

### 2.3 开发工具

| 工具 | 说明 |
|------|------|
| pnpm | 工作区包管理器 |
| ESLint + Prettier | 统一代码风格 |
| tsx | TypeScript 运行器（dev watch） |
| Docker & docker-compose | 一键部署 |

## 3. 项目结构

```
task-flow/
├── packages/
│   ├── client/                    # Vue 前端
│   │   ├── src/
│   │   │   ├── api/               # Axios 封装
│   │   │   │   ├── index.ts       # 统一实例 + 拦截器
│   │   │   │   ├── work-item.ts
│   │   │   │   ├── comment.ts
│   │   │   │   ├── activity-log.ts
│   │   │   │   └── stats.ts
│   │   │   ├── assets/css/main.css
│   │   │   ├── components/
│   │   │   │   ├── common/        # 通用组件（BaseButton、StatusSelect、MarkdownViewer、Toast、ConfirmDialog 等）
│   │   │   │   ├── layout/        # AppLayout, AppSidebar, AppHeader, SidebarCard
│   │   │   │   └── business/      # WorkItemCard, WorkItemForm, SubItemTree, CommentList, Calendar...
│   │   │   ├── composables/       # useToast、useConfirm
│   │   │   ├── router/index.ts
│   │   │   ├── stores/            # work-item.ts、ui.ts
│   │   │   ├── types/index.ts
│   │   │   ├── views/             # WorkItemList/DailyLog/RecycleBin/WorkItemDetail
│   │   │   ├── App.vue
│   │   │   └── main.ts
│   │   └── vite/tailwind/postcss/tsconfig 配置
│   │
│   └── server/                    # Express 后端
│       ├── prisma/schema.prisma   # 数据模型
│       ├── src/
│       │   ├── routes/            # work-item/comment/activity-log/recycle-bin/stats
│       │   ├── services/          # Prisma 访问与业务逻辑拆分
│       │   ├── middleware/error-handler.ts
│       │   ├── types/index.ts     # 扩展 Request & 常量
│       │   ├── utils/response.ts  # success/error 响应体
│       │   └── index.ts           # 应用入口
│       ├── data/                  # SQLite 文件目录
│       ├── package.json
│       └── tsconfig.json
│
├── docker/                        # Dockerfile
├── docker-compose.yml
├── package.json                   # 工作区脚本（dev/build/lint）
├── pnpm-workspace.yaml
└── vibe-coding-doc/               # 文档
```

## 4. 数据库设计

### 4.1 Prisma Schema（关键字段）

```prisma
model WorkItem {
  id        Int      @id @default(autoincrement())
  project   String?  // 所属项目
  tag       String?  // 标签
  type      String?  @default("FEATURE") // FEATURE/BUG/SUPPORT
  title     String
  content   String?
  status    String   @default("pending")
  startTime DateTime?
  endTime   DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?
  parentId  Int?
  parent    WorkItem?  @relation("SubItems", fields: [parentId], references: [id], onDelete: Cascade)
  children  WorkItem[] @relation("SubItems")
  comments  Comment[]
  logs      ActivityLog[]

  @@index([status])
  @@index([deletedAt])
  @@index([parentId])
}

model Comment {
  id        Int      @id @default(autoincrement())
  content   String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  workItem  WorkItem  @relation(fields: [workItemId], references: [id], onDelete: Cascade)
  workItemId Int
}

model ActivityLog {
  id          Int      @id @default(autoincrement())
  type        String   // create/update/status/comment/delete/restore
  description String
  oldValue    String?
  newValue    String?
  createdAt   DateTime  @default(now())
  workItem    WorkItem  @relation(fields: [workItemId], references: [id], onDelete: Cascade)
  workItemId  Int

  @@index([createdAt])
  @@index([type])
}
```

> 说明：为兼容 SQLite，我们将 `type` 存为 `String` 并在业务层做枚举约束。

### 4.2 状态枚举

| 值 | 中文标签 | 颜色 |
|----|----------|------|
| pending | 待处理 | 灰 #9ca3af |
| design | 设计中 | 蓝 #3b82f6 |
| develop | 开发中 | 绿 #10b981 |
| test | 测试中 | 黄 #f59e0b |
| delivery | 交付中 | 橙 #f97316 |
| done | 已完成 | 绿 #22c55e |

### 4.3 工作项类型

| 值 | 说明 |
|----|------|
| FEATURE | 功能迭代 |
| BUG | 缺陷修复 |
| SUPPORT | 支持/运维 |

### 4.4 活动日志类型

| 值 | 说明 |
|----|------|
| create | 创建工作项或子项 |
| update | 更新字段（标题/内容/时间/项目等） |
| status | 状态变更（包含中文提示） |
| comment | 添加评论 |
| delete | 移入回收站 |
| restore | 从回收站恢复 |

## 5. API 设计

### 5.1 基础约定

- 基础路径：`/api/v1`
- 请求格式：`application/json`
- 响应统一：

```ts
interface ApiResponse<T> {
  code: number // 0 表示成功
  data?: T
  message: string
}
```

### 5.2 工作项 API

#### GET /api/v1/work-items

- 返回整棵工作项树（父项在前，子项嵌套在 `children`）并包含 `_count` 与 `childStats`。
- 支持的查询参数：

| 参数 | 说明 |
|------|------|
| `status` | 逗号分隔的状态集合（为空表示全部） |
| `search` | 模糊匹配标题/内容（忽略大小写） |
| `sort` | `createdAt` / `updatedAt` / `startTime` / `endTime` |
| `order` | `asc` / `desc`（默认 `desc`） |

> 服务端先按父子关系组装，再递归过滤 & 排序，确保树结构完整且只展示命中的节点。

#### GET /api/v1/work-items/:id

- 返回单个工作项，包含：
  - 最多三层未删除子项（`children`）。
  - 倒序评论列表。
  - `_count.children` / `_count.comments`。

#### POST /api/v1/work-items

```json
{
  "title": "工作项标题",
  "content": "Markdown 或纯文本",
  "project": "所属项目",
  "tag": "标签",
  "type": "FEATURE",
  "status": "pending",
  "startTime": "2026-02-01T09:00:00.000Z",
  "endTime": "2026-02-15T18:00:00.000Z",
  "parentId": null
}
```

- Zod 校验标题 1~200 字符、内容不超过 5000 字符。
- 创建成功后自动写入 `ActivityLog(create)`，若 `parentId` 存在则描述为“创建子工作项”。

#### PUT /api/v1/work-items/:id

- 任意字段可选更新，示例：

```json
{
  "title": "新的标题",
  "project": null,          // 传 null 清空项目
  "tag": "前端",
  "type": "BUG",
  "status": "develop",
  "startTime": "2026-02-01T09:00:00.000Z",
  "endTime": null
}
```

- 状态变更会单独写入 `ActivityLog(status)`，描述包含中文标签与旧值/新值；其他字段合并记录 `ActivityLog(update)`。

#### DELETE /api/v1/work-items/:id

- 软删除：仅更新 `deletedAt`，同时记录 `ActivityLog(delete)`。

#### POST /api/v1/work-items/:id/restore

- 清空 `deletedAt` 并记录 `ActivityLog(restore)`。

#### DELETE /api/v1/work-items/:id/permanent

- 彻底删除指定工作项（直接 `delete`）。

### 5.3 回收站 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/recycle-bin | 仅返回顶级已删除项，并附加服务端计算的 `expiresAt`（删除时间 + 7 天） |
| DELETE | /api/v1/recycle-bin | 清空全部软删除数据 |

### 5.4 评论 API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/v1/work-items/:workItemId/comments | 添加评论，内容 1~2000 字符 |
| PUT | /api/v1/comments/:id | 编辑评论 |
| DELETE | /api/v1/comments/:id | 删除评论 |

> 新评论会在 `ActivityLog(comment)` 中记录前 50 个字符摘要。

### 5.5 活动日志 API

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/v1/activity-logs | `date`（YYYY-MM-DD）、`type`、`workItemId`、`order` 查询；包含 `workItem{id,title}` |
| GET | /api/v1/activity-logs/calendar | 传入 `year`/`month`，返回 `{ '2026-02-01': 3, ... }` 的日期计数映射 |

### 5.6 统计 API

- `GET /api/v1/stats`
- 并发查询：`total`、`pending`、`inProgress`（design+develop+test+delivery）、`done`、`recycled`。

## 6. 后端实现要点

### 6.1 应用初始化
- `src/index.ts` 创建 Express 应用，挂载 CORS、JSON 解析，并把 PrismaClient 注入 `req.prisma`（通过 `types/index.ts` 扩展类型）。
- 路由拆分：work-items / comments / activity-logs / recycle-bin / stats；评论新增路由直接挂在 work-item 之下满足 REST 语义。

### 6.2 服务层策略
- `services/*` 专注于 Prisma 查询与业务规则（构建树、统计子项、写入 ActivityLog）。
- `utils/response.ts` 统一 `success` / `error` 封装，前端只需关心 `code`。

### 6.3 校验与错误处理
- 所有写操作都用 Zod 校验，确保字段长度/类型合法。
- `errorHandler` 捕获 ZodError 并返回 400，其它异常统一为 500，方便前端 toast 文案。

### 6.4 活动日志
- `ActivityLogType` 枚举集中在 `types/index.ts`，所有增删改操作都在 service 层同步写日志，保证时间线完整。
- `activity-log` service 支持日期区间（起止 00:00~23:59），在 SQLite 中按 `createdAt` 索引加速。

### 6.5 回收站与软删除
- 软删除只作用于顶级项展示，子项由父节点一起被过滤，避免“孤儿”节点。
- 回收站接口在服务端计算 `expiresAt`，便于前端直接显示剩余天数。

## 7. 前端页面与交互

### 7.1 全局布局
- `AppLayout` 统筹 Header + Sidebar + 主内容区域，Sidebar 支持折叠。
- `UI Store` 负责主题（浅色/深色）切换：读取系统偏好、持久化到 localStorage、动态更新 `<html class="dark">`。

### 7.2 工作项列表（WorkItemList.vue）
- 顶部四张统计卡片实时读取 `stats` store。
- 搜索支持 300ms 防抖；状态筛选为多选下拉，选择缓存到 localStorage（`taskflow-filter-statuses`）。
- 树形结构通过 `flatItems` + 自定义虚线引导实现层级感，子项卡片上方标记“子项·第 N 级”。
- `WorkItemCard` 内联 `StatusSelect` 可一键更新状态，并在右侧显示评论数与子项完成度。
- `WorkItemForm + BaseModal` 复用同一个组件完成新建/编辑，提交后刷新列表与统计。

### 7.3 工作项详情（WorkItemDetail.vue）
- 动态面包屑：通过递归请求父节点构建祖先路径。
- `MarkdownViewer` 支持点击编辑、Ctrl+Enter 保存，直接调用 `work-item` API 更新内容。
- 子项区域使用 `SubItemTree`，可在当前上下文添加子项或跳转查看。
- 评论支持增删改：`CommentForm` + `CommentList` + 编辑模态框复用 `BaseModal`。
- 所有危险操作都通过 `ConfirmDialog` 二次确认，并复用 `useToast` 给出结果提示。

### 7.4 日志查看（DailyLog.vue）
- 左侧 `Calendar` 组件展示月视图与热度提示，响应 `month-change` 事件实时拉取 `/activity-logs/calendar`。
- 右侧主卡片以“时间轴”形式展示日志，顶部显示选中日期与星期，底部“END OF DAY”标记结束。
- 可按类型筛选，结合日期过滤器实现“同日同类型”查询。

### 7.5 回收站（RecycleBin.vue）
- 顶部黄色提示强调 7 天清理规则。
- 列表展示删除时间与 `getRemainingDays()` 计算的剩余天数，按钮支持恢复/彻底删除/清空。
- 所有操作完成后刷新列表并同步 `stats`。

## 8. 组件设计

### 8.1 通用组件

| 组件 | 说明 | 亮点 |
|------|------|------|
| BaseButton | 不同 variant/size/loading | 统一色板，支持幽灵按钮 |
| BaseModal | 通用模态框 | 通过 `visible` + 插槽实现任意内容 |
| BaseInput | 表单输入 | 内置 `label` & `error` 提示 |
| StatusTag / StatusSelect | 状态展示 & 交互 | StatusSelect 提供自定义下拉，支持 autosave |
| MarkdownViewer | Markdown 渲染 + 就地编辑 | 结合 marked，支持空态提示 |
| ConfirmDialog | 全局确认框 | `useConfirm` 返回 Promise 风格调用 |
| Toast | 顶部提示 | `useToast` 管理成功/错误信息 |

### 8.2 业务/布局组件

| 组件 | 说明 |
|------|------|
| WorkItemCard | 列表卡片，含状态选择、进度条、项目/标签徽章 |
| WorkItemForm | 多字段表单，支持项目/标签/类型/开始结束时间 |
| SubItemTree | 树形结构，支持展开、快捷操作 |
| CommentList & CommentForm | 评论渲染与提交区域 |
| ActivityLogList | 时间轴式日志展示 |
| Calendar | 自定义月份日历，带热度点 |
| AppLayout/AppHeader/AppSidebar/SidebarCard | 布局与侧卡样式 |

## 9. 状态管理与数据流

### 9.1 work-item store

```ts
interface WorkItemState {
  items: WorkItem[]
  currentItem: WorkItem | null
  loading: boolean
  stats: {
    total: number
    pending: number
    inProgress: number
    done: number
    recycled: number
  }
}
```

- 计算属性：`pendingItems` / `inProgressItems` / `doneItems`。
- 动作：`fetchWorkItems`、`fetchWorkItem`、`create/update/delete/restore/permanentDelete`、`fetchStats`。
- 与 API 交互：所有动作 await 对应 `api/*` 模块，并在必要时刷新统计。

### 9.2 ui store

```ts
interface UIState {
  sidebarCollapsed: boolean
  theme: 'light' | 'dark'
}
```

- 方法：`toggleSidebar`、`setTheme`、`toggleTheme`、`initTheme`（监听系统主题变化，除非用户手动设置）。

### 9.3 数据流与通用能力

- `src/api/index.ts` 中 Axios `baseURL` 指向 `/api/v1`，统一在响应拦截器里解包 `{ code, data }`。
- `useToast`：提供 `success/error/info`，基于 `Toast` 组件的队列渲染。
- `useConfirm`：Promise 化的确认对话框，避免层层回调。
- 所有页面在 `onMounted`/`watch` 中调用 store/action，保持数据单向流动。

## 10. 开发步骤

1. **项目初始化**：创建 pnpm workspace，分别初始化 client/server，配置 Tailwind 与 Prisma。
2. **后端开发**：建模 & 迁移 → 工作项 CRUD → 评论/日志/回收站/统计 → 错误处理 & 验证。
3. **前端开发**：布局与通用组件 → API 封装 → Pinia store → 各页面功能 → Toast/Confirm 联调。
4. **集成测试**：前后端联调、核心流程（创建/更新/删除/恢复/评论/日志）回归。
5. **部署**：`pnpm build`、Docker 镜像、`docker-compose up -d`。

## 11. 环境变量

### 后端 (.env)

```
DATABASE_URL="file:./data/taskflow.db"
PORT=3001
NODE_ENV=development
```

### 前端

- 默认直接请求同源 `/api/v1`，无需额外环境变量。
- 如需自定义后端地址，可在 `src/api/index.ts` 中读取自定义 `VITE_API_BASE_URL`（预留扩展点）。

## 12. 启动命令

```bash
# 安装依赖
pnpm install

# 初始化数据库（生成 + 迁移）
pnpm --filter server prisma:migrate

# 同时启动前后端（开发环境）
pnpm dev
# 或分别启动
pnpm --filter server dev   # http://localhost:3001
pnpm --filter client dev   # http://localhost:3000

# 生产构建
pnpm build
pnpm start  # 默认仅启动 server，可自行托管前端静态文件

# Docker 部署
docker-compose up -d
```

---
当前系统版本：
```
node -v  => v22.14.0
npm -v   => 10.9.2
npx -v   => 10.9.2
```
