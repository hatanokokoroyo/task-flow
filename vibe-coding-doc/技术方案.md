# Task Flow 技术方案

## 1. 项目概述

Task Flow 是一款轻量级的个人工作日志管理系统，支持工作项管理、子任务分解、评论沟通和历史日志查询。系统采用前后端分离架构，数据存储在本地 SQLite 数据库中。

## 2. 技术栈

### 2.1 前端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Vue | 3.x | 渐进式 JavaScript 框架 |
| TypeScript | 5.x | 类型安全 |
| Vite | 5.x | 构建工具 |
| Pinia | 2.x | 状态管理 |
| Vue Router | 4.x | 路由管理 |
| TailwindCSS | 3.x | 原子化 CSS 框架 |
| Axios | 1.x | HTTP 客户端 |
| Day.js | 1.x | 日期处理 |

### 2.2 后端技术栈

| 技术 | 版本 | 说明 |
|------|------|------|
| Node.js | 20.x LTS | 运行时环境 |
| Express | 4.x | Web 框架 |
| TypeScript | 5.x | 类型安全 |
| Prisma | 5.x | ORM 框架 |
| SQLite | 3.x | 数据库 |
| Zod | 3.x | 请求参数校验 |

### 2.3 开发工具

| 工具 | 说明 |
|------|------|
| pnpm | 包管理器 |
| ESLint | 代码检查 |
| Prettier | 代码格式化 |
| tsx | TypeScript 运行 |
| nodemon | 开发热重载 |

## 3. 项目结构

```
task-flow/
├── packages/
│   ├── client/                    # 前端项目
│   │   ├── public/
│   │   ├── src/
│   │   │   ├── api/               # API 接口封装
│   │   │   │   ├── index.ts       # Axios 实例
│   │   │   │   ├── work-item.ts   # 工作项 API
│   │   │   │   ├── comment.ts     # 评论 API
│   │   │   │   └── activity-log.ts# 日志 API
│   │   │   ├── assets/            # 静态资源
│   │   │   │   └── css/
│   │   │   │       └── main.css   # 全局样式
│   │   │   ├── components/        # 组件
│   │   │   │   ├── common/        # 通用组件
│   │   │   │   │   ├── BaseButton.vue
│   │   │   │   │   ├── BaseModal.vue
│   │   │   │   │   ├── BaseInput.vue
│   │   │   │   │   ├── StatusTag.vue
│   │   │   │   │   ├── ConfirmDialog.vue
│   │   │   │   │   └── Toast.vue
│   │   │   │   ├── layout/        # 布局组件
│   │   │   │   │   ├── AppLayout.vue
│   │   │   │   │   ├── AppSidebar.vue
│   │   │   │   │   └── AppHeader.vue
│   │   │   │   └── business/      # 业务组件
│   │   │   │       ├── WorkItemCard.vue
│   │   │   │       ├── WorkItemForm.vue
│   │   │   │       ├── SubItemTree.vue
│   │   │   │       ├── CommentList.vue
│   │   │   │       ├── CommentForm.vue
│   │   │   │       ├── ActivityLogList.vue
│   │   │   │       └── Calendar.vue
│   │   │   ├── composables/       # 组合式函数
│   │   │   │   ├── useToast.ts
│   │   │   │   └── useConfirm.ts
│   │   │   ├── router/            # 路由配置
│   │   │   │   └── index.ts
│   │   │   ├── stores/            # Pinia 状态管理
│   │   │   │   ├── work-item.ts
│   │   │   │   └── ui.ts
│   │   │   ├── types/             # 类型定义
│   │   │   │   └── index.ts
│   │   │   ├── utils/             # 工具函数
│   │   │   │   ├── date.ts
│   │   │   │   └── format.ts
│   │   │   ├── views/             # 页面视图
│   │   │   │   ├── WorkItemList.vue
│   │   │   │   ├── WorkItemDetail.vue
│   │   │   │   ├── DailyLog.vue
│   │   │   │   └── RecycleBin.vue
│   │   │   ├── App.vue
│   │   │   └── main.ts
│   │   ├── index.html
│   │   ├── package.json
│   │   ├── tsconfig.json
│   │   ├── vite.config.ts
│   │   ├── tailwind.config.js
│   │   └── postcss.config.js
│   │
│   └── server/                    # 后端项目
│       ├── prisma/
│       │   └── schema.prisma      # 数据库模型
│       ├── src/
│       │   ├── routes/            # 路由
│       │   │   ├── index.ts
│       │   │   ├── work-item.ts
│       │   │   ├── comment.ts
│       │   │   └── activity-log.ts
│       │   ├── services/          # 业务逻辑
│       │   │   ├── work-item.ts
│       │   │   ├── comment.ts
│       │   │   └── activity-log.ts
│       │   ├── middleware/        # 中间件
│       │   │   ├── error-handler.ts
│       │   │   └── validate.ts
│       │   ├── utils/             # 工具函数
│       │   │   └── response.ts
│       │   ├── types/             # 类型定义
│       │   │   └── index.ts
│       │   └── index.ts           # 入口文件
│       ├── data/                  # 数据库文件目录
│       │   └── .gitkeep
│       ├── package.json
│       └── tsconfig.json
│
├── docker/
│   └── Dockerfile
├── docker-compose.yml
├── package.json                   # 根 package.json (workspace)
├── pnpm-workspace.yaml
└── README.md
```

## 4. 数据库设计

### 4.1 Prisma Schema

```prisma
// packages/server/prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// 工作项表
model WorkItem {
  id          Int       @id @default(autoincrement())
  title       String    // 标题，最大200字符
  content     String?   // 内容，最大5000字符
  status      String    @default("pending") // pending/design/develop/test/delivery/done
  startTime   DateTime? // 开始时间
  endTime     DateTime? // 结束时间
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime? // 软删除时间，null表示未删除

  // 父子关系（自引用）
  parentId    Int?
  parent      WorkItem?   @relation("SubItems", fields: [parentId], references: [id], onDelete: Cascade)
  children    WorkItem[]  @relation("SubItems")

  // 关联
  comments    Comment[]
  logs        ActivityLog[]

  @@index([status])
  @@index([deletedAt])
  @@index([parentId])
}

// 评论表
model Comment {
  id          Int       @id @default(autoincrement())
  content     String    // 评论内容，最大2000字符
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  workItemId  Int
  workItem    WorkItem  @relation(fields: [workItemId], references: [id], onDelete: Cascade)

  @@index([workItemId])
}

// 活动日志表
model ActivityLog {
  id          Int       @id @default(autoincrement())
  type        String    // create/update/status/comment/delete/restore
  description String    // 操作描述
  oldValue    String?   // 变更前的值
  newValue    String?   // 变更后的值
  createdAt   DateTime  @default(now())

  workItemId  Int
  workItem    WorkItem  @relation(fields: [workItemId], references: [id], onDelete: Cascade)

  @@index([workItemId])
  @@index([createdAt])
  @@index([type])
}
```

### 4.2 状态枚举

| 值 | 中文标签 | 颜色 |
|----|----------|------|
| pending | 待处理 | 灰色 #9ca3af |
| design | 设计中 | 蓝色 #3b82f6 |
| develop | 开发中 | 绿色 #10b981 |
| test | 测试中 | 黄色 #f59e0b |
| delivery | 交付中 | 橙色 #f97316 |
| done | 已完成 | 绿色 #22c55e |

### 4.3 活动日志类型

| 值 | 说明 |
|----|------|
| create | 创建工作项/子工作项 |
| update | 编辑工作项 |
| status | 状态变更 |
| comment | 添加评论 |
| delete | 删除到回收站 |
| restore | 从回收站恢复 |

## 5. API 设计

### 5.1 基础信息

- 基础路径: `/api/v1`
- 请求格式: `application/json`
- 响应格式: 统一 JSON 结构

```typescript
// 成功响应
interface SuccessResponse<T> {
  code: 0;
  data: T;
  message: string;
}

// 错误响应
interface ErrorResponse {
  code: number;
  message: string;
  details?: any;
}
```

### 5.2 工作项 API

#### GET /api/v1/work-items
获取工作项列表（仅顶级，不含子项）

**Query 参数:**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 状态筛选 |
| search | string | 否 | 搜索关键词 |
| sort | string | 否 | 排序字段：createdAt/updatedAt/startTime/endTime |
| order | string | 否 | 排序方向：asc/desc |
| includeDeleted | boolean | 否 | 是否包含已删除 |

**响应:**
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "title": "工作项标题",
      "content": "工作项内容",
      "status": "develop",
      "startTime": "2026-02-01T09:00:00.000Z",
      "endTime": "2026-02-15T18:00:00.000Z",
      "createdAt": "2026-01-28T10:30:00.000Z",
      "updatedAt": "2026-02-08T14:20:00.000Z",
      "deletedAt": null,
      "parentId": null,
      "_count": {
        "children": 3,
        "comments": 5
      },
      "childStats": {
        "total": 3,
        "done": 1,
        "percentage": 33
      }
    }
  ],
  "message": "success"
}
```

#### GET /api/v1/work-items/:id
获取工作项详情（含子工作项树和评论）

**响应:**
```json
{
  "code": 0,
  "data": {
    "id": 1,
    "title": "工作项标题",
    "content": "工作项内容",
    "status": "develop",
    "startTime": "2026-02-01T09:00:00.000Z",
    "endTime": "2026-02-15T18:00:00.000Z",
    "createdAt": "2026-01-28T10:30:00.000Z",
    "updatedAt": "2026-02-08T14:20:00.000Z",
    "deletedAt": null,
    "parentId": null,
    "children": [
      {
        "id": 101,
        "title": "子工作项",
        "status": "done",
        "children": []
      }
    ],
    "comments": [
      {
        "id": 1001,
        "content": "评论内容",
        "createdAt": "2026-02-01T17:30:00.000Z"
      }
    ]
  },
  "message": "success"
}
```

#### POST /api/v1/work-items
创建工作项

**请求体:**
```json
{
  "title": "工作项标题",
  "content": "工作项内容",
  "status": "pending",
  "startTime": "2026-02-01T09:00:00.000Z",
  "endTime": "2026-02-15T18:00:00.000Z",
  "parentId": null
}
```

#### PUT /api/v1/work-items/:id
更新工作项

**请求体:**
```json
{
  "title": "更新后的标题",
  "content": "更新后的内容",
  "status": "develop",
  "startTime": "2026-02-01T09:00:00.000Z",
  "endTime": "2026-02-15T18:00:00.000Z"
}
```

#### DELETE /api/v1/work-items/:id
删除工作项（软删除到回收站）

#### POST /api/v1/work-items/:id/restore
从回收站恢复工作项

#### DELETE /api/v1/work-items/:id/permanent
彻底删除工作项

### 5.3 回收站 API

#### GET /api/v1/recycle-bin
获取回收站列表

**响应:**
```json
{
  "code": 0,
  "data": [
    {
      "id": 99,
      "title": "已删除的工作项",
      "status": "done",
      "deletedAt": "2026-02-07T10:00:00.000Z",
      "expiresAt": "2026-02-14T10:00:00.000Z"
    }
  ],
  "message": "success"
}
```

#### DELETE /api/v1/recycle-bin
清空回收站

### 5.4 评论 API

#### POST /api/v1/work-items/:workItemId/comments
添加评论

**请求体:**
```json
{
  "content": "评论内容"
}
```

#### PUT /api/v1/comments/:id
编辑评论

**请求体:**
```json
{
  "content": "更新后的评论内容"
}
```

#### DELETE /api/v1/comments/:id
删除评论

### 5.5 活动日志 API

#### GET /api/v1/activity-logs
获取活动日志列表

**Query 参数:**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| date | string | 否 | 日期筛选（YYYY-MM-DD） |
| type | string | 否 | 类型筛选 |
| workItemId | number | 否 | 工作项ID筛选 |
| order | string | 否 | 排序方向：asc/desc |

**响应:**
```json
{
  "code": 0,
  "data": [
    {
      "id": 1,
      "type": "status",
      "description": "状态从\"设计中\"变更为\"开发中\"",
      "oldValue": "design",
      "newValue": "develop",
      "createdAt": "2026-02-09T09:30:00.000Z",
      "workItem": {
        "id": 1,
        "title": "工作项标题"
      }
    }
  ],
  "message": "success"
}
```

#### GET /api/v1/activity-logs/calendar
获取日历数据（哪些日期有活动）

**Query 参数:**
| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| year | number | 是 | 年份 |
| month | number | 是 | 月份（1-12） |

**响应:**
```json
{
  "code": 0,
  "data": {
    "2026-02-01": 3,
    "2026-02-05": 5,
    "2026-02-08": 2
  },
  "message": "success"
}
```

### 5.6 统计 API

#### GET /api/v1/stats
获取工作项统计

**响应:**
```json
{
  "code": 0,
  "data": {
    "total": 10,
    "pending": 2,
    "inProgress": 5,
    "done": 3,
    "recycled": 1
  },
  "message": "success"
}
```

## 6. 前端页面设计

### 6.1 页面路由

| 路径 | 页面 | 说明 |
|------|------|------|
| / | WorkItemList.vue | 工作项列表页（主页） |
| /work-item/:id | WorkItemDetail.vue | 工作项详情页 |
| /daily-log | DailyLog.vue | 日志查看页 |
| /recycle-bin | RecycleBin.vue | 回收站页面 |

### 6.2 页面功能

#### 6.2.1 工作项列表页 (WorkItemList.vue)
- 统计卡片：显示总数、待处理、进行中、已完成数量
- 搜索框：按标题/内容搜索
- 筛选栏：状态筛选、排序选择
- 工作项卡片列表：显示标题、状态、时间、子项进度、评论数
- 父子层级可视化：通过树状引导线、缩进分组与“子项层级标识”增强嵌套关系识别
- 新建按钮：打开新建工作项模态框
- 操作按钮：编辑、删除

#### 6.2.2 工作项详情页 (WorkItemDetail.vue)
- 面包屑导航
- 工作项信息：标题、状态、时间、内容
- 子项统计卡片：总数、已完成、进行中、完成率
- 子工作项树：支持展开/折叠，添加/编辑/删除子项
- 评论列表：添加/编辑/删除评论
- 侧边栏：快速操作、最近动态

#### 6.2.3 日志查看页 (DailyLog.vue)
- 日历组件：月视图，标记有活动的日期
- 筛选条件：操作类型、工作项、排序方式
- 日志列表：按日期分组显示
- 导出按钮：导出为 Markdown 格式

#### 6.2.4 回收站页面 (RecycleBin.vue)
- 提示信息：7天自动删除警告
- 统计：回收站数量、即将过期数量
- 列表：已删除工作项，显示删除时间、剩余天数
- 操作：恢复、彻底删除、清空回收站

## 7. 组件设计

### 7.1 通用组件

| 组件 | 说明 | Props |
|------|------|-------|
| BaseButton | 按钮 | variant, size, loading, disabled |
| BaseModal | 模态框 | visible, title, width |
| BaseInput | 输入框 | modelValue, type, placeholder, error |
| StatusTag | 状态标签 | status |
| ConfirmDialog | 确认对话框 | visible, title, message, type |
| Toast | 消息提示 | 通过 composable 调用 |

### 7.2 业务组件

| 组件 | 说明 |
|------|------|
| WorkItemCard | 工作项卡片 |
| WorkItemForm | 工作项表单（新建/编辑） |
| SubItemTree | 子工作项树形结构 |
| CommentList | 评论列表 |
| CommentForm | 评论表单 |
| ActivityLogList | 活动日志列表 |
| Calendar | 日历组件 |

## 8. 状态管理

### 8.1 work-item store

```typescript
interface WorkItemState {
  items: WorkItem[];
  currentItem: WorkItem | null;
  loading: boolean;
  stats: {
    total: number;
    pending: number;
    inProgress: number;
    done: number;
  };
}

// Actions
- fetchWorkItems(filters)
- fetchWorkItem(id)
- createWorkItem(data)
- updateWorkItem(id, data)
- deleteWorkItem(id)
- restoreWorkItem(id)
- permanentDeleteWorkItem(id)
- fetchStats()
```

### 8.2 ui store

```typescript
interface UIState {
  sidebarCollapsed: boolean;
  theme: 'light' | 'dark';
}
```

## 9. 开发步骤

### 第一阶段：项目初始化
1. 创建 pnpm workspace 项目结构
2. 初始化前端项目 (Vue 3 + Vite + TypeScript)
3. 初始化后端项目 (Express + TypeScript)
4. 配置 Prisma 和数据库
5. 配置 TailwindCSS

### 第二阶段：后端开发
1. 实现数据库模型和迁移
2. 实现工作项 CRUD API
3. 实现评论 API
4. 实现活动日志 API
5. 实现回收站 API
6. 实现统计 API
7. 添加错误处理中间件
8. 添加请求参数校验

### 第三阶段：前端开发
1. 实现布局组件 (AppLayout, AppSidebar, AppHeader)
2. 实现通用组件
3. 实现 API 封装层
4. 实现状态管理
5. 实现工作项列表页
6. 实现工作项详情页
7. 实现日志查看页
8. 实现回收站页面

### 第四阶段：集成测试
1. 前后端联调
2. 功能测试
3. Bug 修复

### 第五阶段：部署配置
1. 构建生产版本
2. 配置 Docker
3. 编写部署文档

## 10. 环境变量

### 后端 (.env)
```
DATABASE_URL="file:./data/taskflow.db"
PORT=3001
NODE_ENV=development
```

### 前端 (.env)
```
VITE_API_BASE_URL=http://localhost:3001/api/v1
```

## 11. 启动命令

### 开发模式
```bash
# 安装依赖
pnpm install

# 初始化数据库
pnpm --filter server prisma:migrate

# 启动后端
pnpm --filter server dev

# 启动前端
pnpm --filter client dev
```

### 生产模式
```bash
# 构建
pnpm build

# 启动
pnpm start
```

### Docker 部署
```bash
docker-compose up -d
```


---
附当前系统开发工具版本:
PS D:\work\GitHub\task-flow> node -v
v22.14.0
PS D:\work\GitHub\task-flow> npm -v
10.9.2
PS D:\work\GitHub\task-flow> npx -v
10.9.2